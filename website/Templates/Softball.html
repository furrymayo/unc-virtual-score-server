{% extends "base.html" %}
{% block title %}Softball Scoreboard{% endblock %}
{% block container_class %}container-fluid{% endblock %}

{% block content %}
<style>
    /* === Softball-specific layout overrides ===
       No TrackMan/StrikeZone side columns — full-width center layout.
       Scaled up from baseball to fill the extra horizontal space. */

    /* Count bar: single row, no wrap */
    .softball-scoreboard .count-bar {
        margin: 0;
        flex-wrap: nowrap;
    }

    /* Top row: Pitching | Inning | At Bat */
    .softball-scoreboard .info-top-row {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: clamp(8px, 1vw, 16px);
        align-items: stretch;
    }

    /* Section title tighter margins */
    .softball-scoreboard .section-title {
        margin: clamp(4px, 0.6vh, 10px) 0;
    }

    /* Score-count row: team | B/S/O pills | team */
    .softball-scoreboard .score-count-row {
        display: grid;
        grid-template-columns: minmax(80px, 0.22fr) 1fr minmax(80px, 0.22fr);
        gap: clamp(8px, 1vw, 16px);
        align-items: stretch;
    }

    /* Team cards in score row — larger without side columns */
    .softball-scoreboard .score-count-row .team-card {
        padding: clamp(4px, 0.6vh, 12px);
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .softball-scoreboard .score-count-row .team-label {
        font-size: clamp(0.9rem, 1.2vw, 1.8rem);
        justify-content: center;
    }
    .softball-scoreboard .score-count-row .team-score {
        font-size: clamp(2.5rem, 4vw, 6rem);
    }

    /* Compact center cards in top row */
    .softball-scoreboard .info-top-row .center-card {
        padding: clamp(8px, 1vh, 16px);
    }

    /* Balls/Strikes/Outs: pronounced cards with glow — larger than baseball */
    .softball-scoreboard .count-pill {
        padding: clamp(10px, 1.4vh, 22px) clamp(14px, 2vw, 34px);
        min-width: clamp(120px, 12vw, 220px);
        background: linear-gradient(
            145deg,
            rgba(15, 42, 82, 0.95) 0%,
            rgba(20, 55, 100, 0.92) 50%,
            rgba(18, 48, 88, 0.95) 100%
        );
        border: 1px solid rgba(75, 156, 211, 0.45);
        box-shadow:
            inset 0 1px 1px rgba(131, 198, 242, 0.08),
            0 0 8px rgba(75, 156, 211, 0.25),
            0 0 20px rgba(75, 156, 211, 0.15),
            0 8px 24px rgba(3, 9, 18, 0.4);
    }
    .softball-scoreboard .count-value {
        font-size: clamp(3.2rem, 5.5vw, 8rem);
        color: #ffffff;
        text-shadow:
            0 0 12px rgba(75, 156, 211, 0.5),
            0 0 24px rgba(75, 156, 211, 0.2);
    }
    .softball-scoreboard .count-label {
        font-size: clamp(1.1rem, 1.8vw, 2.6rem);
        font-weight: 700;
        color: rgba(131, 198, 242, 0.85);
        text-shadow: 0 0 8px rgba(75, 156, 211, 0.15);
    }

    /* Pitching/At Bat cards: scaled up */
    .softball-scoreboard .info-top-row .center-label {
        font-size: clamp(0.9rem, 1.4vw, 2rem);
    }
    .softball-scoreboard .center-value.compact {
        font-size: clamp(1.6rem, 2.6vw, 3.6rem);
    }
    .softball-scoreboard .stat-value.compact {
        font-size: clamp(1.2rem, 2vw, 2.8rem);
    }

    /* Linescore */
    .softball-scoreboard .linescore-full {
        margin-top: clamp(6px, 0.8vh, 12px);
    }

    /* Linescore team name: short code, constrained width */
    .softball-scoreboard .team-row-label {
        font-size: clamp(1.6rem, 2.2vw, 2.8rem);
        text-align: left;
        max-width: 6ch;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Inning headers */
    .softball-scoreboard .table-grid th {
        font-size: clamp(1.5rem, 2vw, 2.8rem);
    }

    /* Inning data */
    .softball-scoreboard .table-grid td {
        font-size: clamp(1.8rem, 2.6vw, 3.4rem);
    }

    /* R/H/E card: visual separation */
    .softball-scoreboard .linescore-total,
    .softball-scoreboard .linescore-label {
        font-size: clamp(2rem, 3vw, 4rem) !important;
        font-weight: 700;
        background: linear-gradient(135deg, rgba(18, 39, 66, 0.95), rgba(20, 52, 82, 0.9)) !important;
    }
    .softball-scoreboard .table-grid th:nth-last-child(3),
    .softball-scoreboard .table-grid td:nth-last-child(3) {
        border-left: 3px solid var(--carolina);
        padding-left: 12px;
    }

    /* Config panel reduced margin */
    .softball-scoreboard ~ details.data-sources-panel {
        margin-top: 8px;
    }
</style>

<section class="scoreboard-shell diamond-sport softball-scoreboard">
    <div class="scoreboard-header">
        <div>
            <div class="scoreboard-title">Softball</div>
            <div class="scoreboard-subtitle" id="sb-venue-info">Live scoreboard feed</div>
        </div>
        <div class="meta-row">
            <div class="meta-chip" id="sb-weather-chip" style="display: none;"><span id="sb-weather">--</span></div>
        </div>
    </div>

    <div class="info-top-row">
        <div class="center-card compact">
            <div class="center-label" id="sb-pitching-label">Pitching</div>
            <div class="center-value compact" id="sb-current-pitcher">--</div>
            <div class="stat-value compact" id="sb-pitcher-line" style="color: var(--ink-soft);">--</div>
        </div>
        <div class="center-card compact" style="text-align: center;">
            <div class="base-diamond">
                <div class="base-diamond-shape"></div>
                <div class="base-marker base-first" id="sb-base-1"></div>
                <div class="base-marker base-second" id="sb-base-2"></div>
                <div class="base-marker base-third" id="sb-base-3"></div>
            </div>
            <div class="center-value" id="sb-half-inning">n/a</div>
        </div>
        <div class="center-card compact">
            <div class="center-label" id="sb-atbat-label">At Bat</div>
            <div class="center-value compact" id="sb-current-batter">--</div>
            <div class="stat-value compact" id="sb-batter-game" style="color: var(--ink-soft);">--</div>
            <div class="stat-value compact" id="sb-batter-season" style="color: var(--ink-soft);">--</div>
        </div>
    </div>

    <div class="score-count-row" style="margin-top: clamp(6px, 0.8vh, 12px);">
        <div class="team-card team-away">
            <div class="team-label"><span id="sb-away-name">Away</span></div>
            <div class="team-score" id="sb-away-runs">--</div>
        </div>
        <div class="count-bar">
            <div class="count-pill">
                <div class="count-label">Balls</div>
                <div class="count-value" id="sb-balls">--</div>
            </div>
            <div class="count-pill">
                <div class="count-label">Strikes</div>
                <div class="count-value" id="sb-strikes">--</div>
            </div>
            <div class="count-pill">
                <div class="count-label">Outs</div>
                <div class="count-value" id="sb-outs">--</div>
            </div>
        </div>
        <div class="team-card team-home">
            <div class="team-label"><span id="sb-home-name">Home</span></div>
            <div class="team-score" id="sb-home-runs">--</div>
        </div>
    </div>

    <div class="linescore-full">
        <div class="section-title">Innings</div>
        <div class="table-card">
            <div id="sb-linescore-table"></div>
        </div>
    </div>
</section>

<details class="trackman-shell trackman-config-compact data-sources-panel" style="margin-top: 8px;">
    <summary class="scoreboard-header" style="margin-bottom: 10px; cursor: pointer;">
        <div style="display: flex; align-items: center;">
            <span class="dropdown-indicator"></span>
            <div class="scoreboard-subtitle">Additional Data Sources</div>
        </div>
        <div class="meta-row">
            <div class="meta-chip">StatCrew <span id="sb-sc-status">n/a</span></div>
        </div>
    </summary>

    <div class="section-title" style="margin-top: 8px; margin-bottom: 8px;">StatCrew XML</div>
    <form id="sb-statcrew-form" class="config-grid">
        <div style="grid-column: span 2;">
            <label for="sb-statcrew-path">StatCrew XML File Path</label>
            <div class="path-input-group">
                <input id="sb-statcrew-path" type="text" placeholder="/path/to/statcrew.xml" />
                <button type="button" class="btn-browse" onclick="openFileBrowser('sb-statcrew-path')">Browse</button>
            </div>
        </div>
        <div>
            <label for="sb-statcrew-enabled">Enabled</label>
            <select id="sb-statcrew-enabled">
                <option value="true">Enabled</option>
                <option value="false">Disabled</option>
            </select>
        </div>
        <div class="d-flex align-items-end">
            <button type="submit" class="btn-config w-100">Save StatCrew</button>
        </div>
    </form>
</details>

<script>
    let statcrewData = {};
    let oesData = {};
    let currentHalf = '';  // TOP or BOT from OES batting_team

    // Returns which team is batting: 'away' or 'home'.
    // Prefers StatCrew XML (batting_team) over OES half-inning state.
    function getBattingTeam() {
        if (statcrewData.batting_team) return statcrewData.batting_team;
        if (currentHalf === 'TOP') return 'away';
        if (currentHalf === 'BOT') return 'home';
        return '';
    }

    function renderSoftball(data) {
        oesData = data || {};

        setText('sb-balls', data.balls);
        setText('sb-strikes', data.strikes);
        setText('sb-outs', data.outs);
        setText('sb-away-runs', data.away_runs);
        setText('sb-home-runs', data.home_runs);

        // Build half-inning display from separate OES fields
        var bt = data.batting_team || '';
        var inn = data.inning || '';
        if (bt) currentHalf = bt.toUpperCase();

        var display = bt && inn ? bt + ' ' + inn : (bt || inn || 'n/a');
        setText('sb-half-inning', display);

        var awayInnings = Array.isArray(data.away_innings) ? data.away_innings : [];
        var homeInnings = Array.isArray(data.home_innings) ? data.home_innings : [];

        renderLinescoreSoftball(awayInnings, homeInnings, {
            away: { runs: data.away_runs, hits: data.away_hits, errors: data.away_errors, label: 'Away' },
            home: { runs: data.home_runs, hits: data.home_hits, errors: data.home_errors, label: 'Home' }
        });

        updateCurrentPitcher();
        updateCurrentBatter();
    }

    function renderStatcrewSoftball(data) {
        statcrewData = data || {};
        if (data.away_team_color) applyAwayTeamColor(data.away_team_color);

        var venue = data.venue || {};
        if (venue.stadium || venue.location) {
            var parts = [venue.stadium, venue.location].filter(Boolean);
            setText('sb-venue-info', parts.join(' - ') || 'Live scoreboard feed');
        }

        if (venue.weather || venue.temp) {
            var weatherChip = document.getElementById('sb-weather-chip');
            if (weatherChip) weatherChip.style.display = 'block';
            setText('sb-weather', venue.weather || (venue.temp ? venue.temp + '\u00B0F' : '--'));
        }

        setText('sb-away-name', data.away_name || 'Away');
        setText('sb-home-name', data.home_name || 'Home');

        // Inning display from StatCrew (has MID/END transitions)
        if (data.inning_display) {
            setText('sb-half-inning', data.inning_display);
        }

        updateCurrentPitcher();
        updateCurrentBatter();
        updateDiamond();
    }

    function updateDiamond() {
        var first = document.getElementById('sb-base-1');
        var second = document.getElementById('sb-base-2');
        var third = document.getElementById('sb-base-3');
        if (!first) return;
        first.classList.toggle('occupied', !!(statcrewData.runner_first));
        second.classList.toggle('occupied', !!(statcrewData.runner_second));
        third.classList.toggle('occupied', !!(statcrewData.runner_third));
    }

    function formatPlayerName(name) {
        if (!name) return '--';
        var parts = name.split(',');
        if (parts.length === 2) {
            var last = parts[0].trim();
            var first = parts[1].trim();
            return first + ' ' + last;
        }
        return name;
    }

    function updateCurrentPitcher() {
        var batting = getBattingTeam();

        // Try StatCrew first
        if (batting) {
            var prefix = batting === 'away' ? 'home' : 'away';

            // Team tricode + color
            var tricode = statcrewData[prefix + '_id'] || '';
            var color = prefix === 'home' ? 'var(--carolina-soft)' : 'var(--away-color, #d46a6a)';
            var label = document.getElementById('sb-pitching-label');
            var nameEl = document.getElementById('sb-current-pitcher');
            if (label) { label.textContent = tricode ? tricode + ' Pitching' : 'Pitching'; label.style.color = color; }
            if (nameEl) nameEl.style.color = color;

            var pName = statcrewData[prefix + '_pitcher_name'] || '';

            if (pName) {
                var pUni = statcrewData[prefix + '_pitcher_uni'] || '';
                setText('sb-current-pitcher', formatPlayerName(pName) + (pUni ? ' #' + pUni : ''));

                var ip = statcrewData[prefix + '_pitcher_ip'] || '--';
                var so = statcrewData[prefix + '_pitcher_so'] || '--';
                var pitches = statcrewData[prefix + '_pitcher_pitches'] || '';
                var line = ip + ' IP | ' + so + ' K';
                if (pitches) line += ' | ' + pitches + ' P';
                setText('sb-pitcher-line', line);
                return;
            }
        }

        // OES fallback — softball provides pitcher_num and pitcher_count
        var pNum = oesData.pitcher_num ? String(oesData.pitcher_num).trim() : '';
        if (pNum) {
            setText('sb-current-pitcher', '#' + pNum);
            var count = oesData.pitcher_count ? String(oesData.pitcher_count).trim() + ' pitches' : '--';
            setText('sb-pitcher-line', count);
        }
    }

    function updateCurrentBatter() {
        var name = statcrewData.current_batter_name || '';
        var batting = getBattingTeam();

        // Team tricode + color (only when we know who's batting)
        if (batting) {
            var tricode = statcrewData[batting + '_id'] || '';
            var color = batting === 'home' ? 'var(--carolina-soft)' : 'var(--away-color, #d46a6a)';
            var label = document.getElementById('sb-atbat-label');
            var nameEl = document.getElementById('sb-current-batter');
            if (label) { label.textContent = tricode ? tricode + ' At Bat' : 'At Bat'; label.style.color = color; }
            if (nameEl) nameEl.style.color = color;
        }

        if (name) {
            // StatCrew path: find batter in lineup for stats
            var normalize = function(s) {
                return s.replace(/\./g, '').replace(/,\s+/g, ',').replace(/\s+/g, '');
            };
            var target = normalize(name);
            var batters = batting ? (statcrewData[batting + '_batters'] || []) : [];
            var batter = batters.find(function(b) {
                if (!b.name) return false;
                return normalize(b.name) === target || b.name === name;
            });

            if (batter) {
                setText('sb-current-batter', formatPlayerName(batter.name) + (batter.uni ? ' #' + batter.uni : ''));
                var ab = batter.ab || '--';
                var h = batter.h || '--';
                var rbi = batter.rbi || '--';
                var hr = batter.hr || '0';
                var avg = batter.avg || '';
                var seasonHr = batter.season_hr || '';
                var gameLine = 'Today: ' + h + '-' + ab + ' | ' + rbi + ' RBI';
                if (hr !== '0') gameLine += ' | ' + hr + ' HR';
                setText('sb-batter-game', gameLine);
                var seasonLine = '';
                if (avg) {
                    seasonLine = 'Season: ' + avg + ' AVG';
                    if (seasonHr && seasonHr !== '0') seasonLine += ' | ' + seasonHr + ' HR';
                }
                setText('sb-batter-season', seasonLine || '--');
            } else {
                setText('sb-current-batter', formatPlayerName(name));
                setText('sb-batter-game', '--');
                setText('sb-batter-season', '--');
            }
            return;
        }

        // OES fallback — softball provides batter_num and batter_avg
        var bNum = oesData.batter_num ? String(oesData.batter_num).trim() : '';
        if (bNum) {
            setText('sb-current-batter', '#' + bNum);
            var avg = oesData.batter_avg ? String(oesData.batter_avg).trim() : '';
            setText('sb-batter-game', '--');
            setText('sb-batter-season', avg ? 'Season: .' + avg + ' AVG' : '--');
        }
    }

    function fetchStatcrewSoftballData() {
        fetch('/get_statcrew_data/Softball')
            .then(function(response) { return response.json(); })
            .then(function(data) { renderStatcrewSoftball(data || {}); })
            .catch(function() { renderStatcrewSoftball({}); });
    }

    function renderLinescoreSoftball(awayInnings, homeInnings, totals) {
        var table = document.getElementById('sb-linescore-table');
        if (!table) return;

        var isFilled = function(value) {
            return value !== undefined && value !== null && String(value).trim() !== '';
        };
        var lastFilledIndex = function(arr) {
            for (var i = arr.length - 1; i >= 0; i -= 1) {
                if (isFilled(arr[i])) return i;
            }
            return -1;
        };

        var lastAway = lastFilledIndex(awayInnings);
        var lastHome = lastFilledIndex(homeInnings);
        var minInnings = 7;
        var inningCount = Math.max(minInnings, lastAway + 1, lastHome + 1, awayInnings.length, homeInnings.length);

        var renderRow = function(label, innings, total, rowClass) {
            var cells = [];
            var teamLabel = total.label || label;
            cells.push('<td class="team-row-label">' + teamLabel + '</td>');
            for (var i = 0; i < inningCount; i += 1) {
                var value = formatValue(innings[i]);
                cells.push('<td>' + value + '</td>');
            }
            cells.push('<td class="linescore-total">' + formatValue(total.runs) + '</td>');
            cells.push('<td class="linescore-total">' + formatValue(total.hits) + '</td>');
            cells.push('<td class="linescore-total">' + formatValue(total.errors) + '</td>');
            return '<tr class="' + rowClass + '">' + cells.join('') + '</tr>';
        };

        var headers = [''].concat(
            Array.from({ length: inningCount }, function(_, idx) { return '' + (idx + 1); }),
            ['R', 'H', 'E']
        );

        var headerCells = headers.map(function(label, index) {
            if (index >= headers.length - 3 && label) {
                return '<th class="linescore-label">' + label + '</th>';
            }
            return '<th>' + label + '</th>';
        }).join('');

        table.innerHTML =
            '<table class="table-grid">' +
                '<thead><tr>' + headerCells + '</tr></thead>' +
                '<tbody>' +
                    renderRow('Away', awayInnings, totals.away, 'linescore-away') +
                    renderRow('Home', homeInnings, totals.home, 'linescore-home') +
                '</tbody>' +
            '</table>';
    }

    function fetchSoftballData() {
        fetchData('Softball');
    }

    fetchSoftballData();
    setInterval(fetchSoftballData, 1000);

    fetchStatcrewSoftballData();
    setInterval(fetchStatcrewSoftballData, 2000);

    loadStatcrewConfig('Softball', 'sb');
    document.getElementById('sb-statcrew-form').addEventListener('submit', function(e) {
        submitStatcrewConfig(e, 'Softball', 'sb');
    });

    document.addEventListener('dataFetched', function(event) {
        renderSoftball(event.detail || {});
    });
</script>
{% endblock %}
