{% extends "base.html" %}
{% block title %}Softball Scoreboard{% endblock %}
{% block container_class %}container-fluid{% endblock %}

{% block content %}
<section class="scoreboard-shell diamond-sport">
    <div class="scoreboard-header">
        <div>
            <div class="scoreboard-title">Softball</div>
            <div class="scoreboard-subtitle" id="sb-venue-info">Live scoreboard feed</div>
        </div>
        <div class="meta-row">
            <div class="meta-chip">Inning <span id="sb-inning">--</span></div>
            <div class="meta-chip">Pitch <span id="sb-pitch-speed">--</span></div>
        </div>
    </div>

    <div class="count-bar">
        <div class="count-pill">
            <div class="count-label">Balls</div>
            <div class="count-value" id="sb-balls">--</div>
        </div>
        <div class="count-pill">
            <div class="count-label">Strikes</div>
            <div class="count-value" id="sb-strikes">--</div>
        </div>
        <div class="count-pill">
            <div class="count-label">Outs</div>
            <div class="count-value" id="sb-outs">--</div>
        </div>
    </div>

    <div class="score-grid">
        <div class="team-card">
            <div class="team-label"><span id="sb-away-name">Away</span> <span id="sb-away-record" class="team-record"></span></div>
            <div class="team-score" id="sb-away-runs">--</div>
            <div class="team-meta">
                <div class="stat-line"><span>Hits</span><strong id="sb-away-hits">--</strong></div>
                <div class="stat-line"><span>Errors</span><strong id="sb-away-errors">--</strong></div>
            </div>
        </div>
        <div class="center-card">
            <div class="center-label">Inning</div>
            <div class="center-value" id="sb-half-inning">--</div>
        </div>
        <div class="team-card">
            <div class="team-label"><span id="sb-home-name">Home</span> <span id="sb-home-record" class="team-record"></span></div>
            <div class="team-score" id="sb-home-runs">--</div>
            <div class="team-meta">
                <div class="stat-line"><span>Hits</span><strong id="sb-home-hits">--</strong></div>
                <div class="stat-line"><span>Errors</span><strong id="sb-home-errors">--</strong></div>
            </div>
        </div>
    </div>

    <div class="stat-grid">
        <div class="stat-card">
            <div class="stat-label">Batter</div>
            <div class="stat-value" id="sb-batter-num">--</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Batter Avg</div>
            <div class="stat-value" id="sb-batter-avg">--</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Pitcher</div>
            <div class="stat-value" id="sb-pitcher-num">--</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Pitch Count</div>
            <div class="stat-value" id="sb-pitcher-count">--</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Last Play</div>
            <div class="stat-value" id="sb-last-play">--</div>
        </div>
    </div>

    <div class="section-title">Innings</div>
    <div class="table-card">
        <div id="sb-linescore-table"></div>
    </div>

    <div class="score-trackman-layout">
        <div>
            <div class="section-title">TrackMan Dashboard</div>
            <div class="trackman-shell">
                <div class="trackman-section-label">Pitching</div>
                <div class="trackman-grid">
                    <div class="trackman-card">
                        <div class="trackman-label">Release Speed</div>
                        <div class="trackman-value" id="sb-tm-pitch-speed">n/a</div>
                        <div class="trackman-unit">MPH</div>
                    </div>
                    <div class="trackman-card">
                        <div class="trackman-label">Spin Rate</div>
                        <div class="trackman-value" id="sb-tm-spin-rate">n/a</div>
                        <div class="trackman-unit">RPM</div>
                    </div>
                    <div class="trackman-card trackman-zone" style="grid-column: span 2;">
                        <div class="trackman-label">Strike Zone</div>
                        <div class="zone-canvas">
                            <div class="zone-grid">
                                <div class="zone-line v v1"></div>
                                <div class="zone-line v v2"></div>
                                <div class="zone-line h h1"></div>
                                <div class="zone-line h h2"></div>
                            </div>
                            <div class="zone-dot" id="sb-zone-dot"></div>
                        </div>
                        <div class="trackman-unit" id="sb-zone-readout">n/a</div>
                    </div>
                </div>
                <div class="trackman-section-label" style="margin-top: 8px;">Batting</div>
                <div class="trackman-grid">
                    <div class="trackman-card">
                        <div class="trackman-label">Exit Angle</div>
                        <div class="trackman-value" id="sb-tm-launch-angle">n/a</div>
                        <div class="trackman-unit">Degrees</div>
                    </div>
                    <div class="trackman-card">
                        <div class="trackman-label">Distance</div>
                        <div class="trackman-value" id="sb-tm-distance">n/a</div>
                        <div class="trackman-unit">Feet</div>
                    </div>
                    <div class="trackman-card">
                        <div class="trackman-label">Exit Speed</div>
                        <div class="trackman-value" id="sb-tm-exit-velocity">n/a</div>
                        <div class="trackman-unit">MPH</div>
                    </div>
                </div>
            </div>
        </div>
        <div>
            <div class="count-bar">
                <div class="count-pill">
                    <div class="count-label">Balls</div>
                    <div class="count-value" id="sb-balls">--</div>
                </div>
                <div class="count-pill">
                    <div class="count-label">Strikes</div>
                    <div class="count-value" id="sb-strikes">--</div>
                </div>
                <div class="count-pill">
                    <div class="count-label">Outs</div>
                    <div class="count-value" id="sb-outs">--</div>
                </div>
            </div>

            <div class="score-grid">
                <div class="team-card">
                    <div class="team-label">Away</div>
                    <div class="team-score" id="sb-away-runs">--</div>
                    <div class="diamond-divider"></div>
                    <div class="team-meta">
                        <div class="stat-line"><span>Hits</span><strong id="sb-away-hits">--</strong></div>
                        <div class="diamond-divider"></div>
                        <div class="stat-line"><span>Errors</span><strong id="sb-away-errors">--</strong></div>
                    </div>
                </div>
                <div class="center-card">
                    <div class="center-label">Inning</div>
                    <div class="center-value" id="sb-half-inning">--</div>
                </div>
                <div class="team-card">
                    <div class="team-label">Home</div>
                    <div class="team-score" id="sb-home-runs">--</div>
                    <div class="diamond-divider"></div>
                    <div class="team-meta">
                        <div class="stat-line"><span>Hits</span><strong id="sb-home-hits">--</strong></div>
                        <div class="diamond-divider"></div>
                        <div class="stat-line"><span>Errors</span><strong id="sb-home-errors">--</strong></div>
                    </div>
                </div>
            </div>

            <div class="section-title">Innings</div>
            <div class="table-card">
                <div id="sb-linescore-table"></div>
            </div>
        </div>
    </div>

    <div class="trackman-meta">
        <div class="stat-card">
            <div class="stat-label">Track ID</div>
            <div class="stat-value" id="sb-tm-track-id">n/a</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Timestamp</div>
            <div class="stat-value" id="sb-tm-time">n/a</div>
        </div>
    </div>

</section>

<details class="trackman-shell trackman-config-compact data-sources-panel" style="margin-top: 16px;">
    <summary class="scoreboard-header" style="margin-bottom: 10px; cursor: pointer;">
        <div style="display: flex; align-items: center;">
            <span class="dropdown-indicator"></span>
            <div class="scoreboard-subtitle">Additional Data Sources</div>
        </div>
        <div class="meta-row">
            <div class="meta-chip">TrackMan <span id="sb-tm-status">n/a</span></div>
            <div class="meta-chip">StatCrew <span id="sb-sc-status">n/a</span></div>
        </div>
    </summary>

    <div class="section-title" style="margin-top: 8px; margin-bottom: 8px;">TrackMan UDP</div>
    <form id="sb-trackman-form" class="config-grid">
        <div>
            <label for="sb-trackman-port">UDP Port</label>
            <input id="sb-trackman-port" type="number" min="1" max="65535" placeholder="20998" />
        </div>
        <div>
            <label for="sb-trackman-feed-type">Feed Type</label>
            <select id="sb-trackman-feed-type">
                <option value="broadcast">Broadcast (Pitch + Hit, UDP 20998)</option>
                <option value="scoreboard">Scoreboard (Pitch OR Hit, UDP 20999)</option>
            </select>
        </div>
        <div>
            <label for="sb-trackman-enabled">Enabled</label>
            <select id="sb-trackman-enabled">
                <option value="true">Enabled</option>
                <option value="false">Disabled</option>
            </select>
        </div>
        <div class="d-flex align-items-end">
            <button type="submit" class="btn-config w-100">Save TrackMan</button>
        </div>
    </form>

    <div class="section-title" style="margin-top: 12px; margin-bottom: 8px;">StatCrew XML</div>
    <form id="sb-statcrew-form" class="config-grid">
        <div style="grid-column: span 2;">
            <label for="sb-statcrew-path">StatCrew XML File Path</label>
            <div class="path-input-group">
                <input id="sb-statcrew-path" type="text" placeholder="/path/to/statcrew.xml" />
                <button type="button" class="btn-browse" onclick="openFileBrowser('sb-statcrew-path')">Browse</button>
            </div>
        </div>
        <div>
            <label for="sb-statcrew-enabled">Enabled</label>
            <select id="sb-statcrew-enabled">
                <option value="true">Enabled</option>
                <option value="false">Disabled</option>
            </select>
        </div>
        <div class="d-flex align-items-end">
            <button type="submit" class="btn-config w-100">Save StatCrew</button>
        </div>
    </form>
</details>

<script>
    let statcrewData = {};

    function renderSoftball(data) {
        setText('sb-inning', data.inning);
        setText('sb-balls', data.balls);
        setText('sb-strikes', data.strikes);
        setText('sb-outs', data.outs);
        setText('sb-pitch-speed', data.pitch_speed);
        const halfInning = data.batting_team && data.inning
            ? `${data.batting_team} ${data.inning}`
            : (data.batting_team || data.inning);
        setText('sb-half-inning', halfInning);
        setText('sb-away-runs', data.away_runs);
        setText('sb-away-hits', data.away_hits);
        setText('sb-away-errors', data.away_errors);
        setText('sb-home-runs', data.home_runs);
        setText('sb-home-hits', data.home_hits);
        setText('sb-home-errors', data.home_errors);
        setText('sb-batter-num', data.batter_num);
        setText('sb-batter-avg', data.batter_avg);
        setText('sb-pitcher-num', data.pitcher_num);
        setText('sb-pitcher-count', data.pitcher_count);
        setText('sb-last-play', data.last_play);

        const awayInnings = Array.isArray(data.away_innings) ? data.away_innings : [];
        const homeInnings = Array.isArray(data.home_innings) ? data.home_innings : [];
        renderLinescoreSoftball(awayInnings, homeInnings, {
            away: { runs: data.away_runs, hits: data.away_hits, errors: data.away_errors },
            home: { runs: data.home_runs, hits: data.home_hits, errors: data.home_errors }
        });
    }

    function renderStatcrewSoftball(data) {
        statcrewData = data || {};
        const info = getStatcrewTeamInfo(statcrewData);
        setText('sb-venue-info', info.venueText || 'Live scoreboard feed');
        setText('sb-away-name', info.visitorName || 'Away');
        setText('sb-home-name', info.homeName || 'Home');
        setText('sb-away-record', info.visitorRecord ? '(' + info.visitorRecord + ')' : '', '');
        setText('sb-home-record', info.homeRecord ? '(' + info.homeRecord + ')' : '', '');
    }

    function renderLinescoreSoftball(awayInnings, homeInnings, totals) {
        const table = document.getElementById('sb-linescore-table');
        if (!table) {
            return;
        }

        const isFilled = (value) => value !== undefined && value !== null && String(value).trim() !== '';
        const lastFilledIndex = (arr) => {
            for (let i = arr.length - 1; i >= 0; i -= 1) {
                if (isFilled(arr[i])) {
                    return i;
                }
            }
            return -1;
        };

        const lastAway = lastFilledIndex(awayInnings);
        const lastHome = lastFilledIndex(homeInnings);
        const minInnings = 7;
        const inningCount = Math.max(minInnings, lastAway + 1, lastHome + 1, awayInnings.length, homeInnings.length);

        const renderRow = (label, innings, total) => {
            const cells = [];
            cells.push(`<td class="team-row-label">${label}</td>`);
            for (let i = 0; i < inningCount; i += 1) {
                const value = formatValue(innings[i]);
                cells.push(`<td>${value}</td>`);
            }
            cells.push(`<td class="linescore-total">${formatValue(total.runs)}</td>`);
            cells.push(`<td class="linescore-total">${formatValue(total.hits)}</td>`);
            cells.push(`<td class="linescore-total">${formatValue(total.errors)}</td>`);
            return `<tr>${cells.join('')}</tr>`;
        };

        const headers = [''].concat(
            Array.from({ length: inningCount }, (_, idx) => `${idx + 1}`),
            ['R', 'H', 'E']
        );

        const headerCells = headers.map((label, index) => {
            if (index >= headers.length - 3 && label) {
                return `<th class="linescore-label">${label}</th>`;
            }
            return `<th>${label}</th>`;
        }).join('');

        table.innerHTML = `
            <table class="table-grid">
                <thead>
                    <tr>${headerCells}</tr>
                </thead>
                <tbody>
                    ${renderRow('Away', awayInnings, totals.away)}
                    ${renderRow('Home', homeInnings, totals.home)}
                </tbody>
            </table>
        `;
    }

    function renderTrackmanSoftball(data) {
        setText('sb-tm-pitch-speed', data.pitch_speed);
        setText('sb-tm-spin-rate', data.spin_rate);
        setText('sb-tm-exit-velocity', data.hit_exit_velocity);
        setText('sb-tm-launch-angle', data.hit_launch_angle);
        setText('sb-tm-distance', data.hit_distance);
        setText('sb-tm-track-id', data.track_id);
        setText('sb-tm-time', data.time);

        updateStrikeZone('sb-zone-dot', 'sb-zone-readout', data, {
            zone: { minX: -0.83, maxX: 0.83, minV: 1.5, maxV: 3.3775 },
            margin: 1.0,
            xOffset: 1.42,
            xScale: 0.85
        });
    }

    function renderTrackmanConfigSoftball(config) {
        const status = config.error
            ? 'error'
            : (config.enabled ? (config.running ? 'live' : 'idle') : 'disabled');
        setText('sb-tm-status', status);
        document.getElementById('sb-trackman-port').value = config.port || '';
        document.getElementById('sb-trackman-feed-type').value = config.feed_type || 'broadcast';
        document.getElementById('sb-trackman-enabled').value = config.enabled ? 'true' : 'false';
    }

    function loadTrackmanSoftballConfig() {
        fetch('/trackman_config/Softball')
            .then(response => response.json())
            .then(data => renderTrackmanConfigSoftball(data || {}))
            .catch(() => renderTrackmanConfigSoftball({ enabled: false }));
    }

    function bindTrackmanSoftballDefaults() {
        const portInput = document.getElementById('sb-trackman-port');
        const feedSelect = document.getElementById('sb-trackman-feed-type');
        const applyDefault = () => {
            if (!portInput.value) {
                portInput.value = feedSelect.value === 'scoreboard' ? '20999' : '20998';
            }
        };
        feedSelect.addEventListener('change', applyDefault);
        applyDefault();
    }

    function submitTrackmanSoftballConfig(event) {
        event.preventDefault();
        const port = parseInt(document.getElementById('sb-trackman-port').value, 10);
        const feedType = document.getElementById('sb-trackman-feed-type').value;
        const enabled = document.getElementById('sb-trackman-enabled').value === 'true';
        fetch('/trackman_config/Softball', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ port: port, feed_type: feedType, enabled: enabled })
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => { throw data; });
                }
                return response.json();
            })
            .then(data => renderTrackmanConfigSoftball(data || {}))
            .catch(error => renderTrackmanConfigSoftball({ enabled: false, error: error.error || 'error' }));
    }

    function fetchTrackmanSoftballData() {
        fetch('/get_trackman_data/Softball')
            .then(response => response.json())
            .then(data => renderTrackmanSoftball(data || {}))
            .catch(() => renderTrackmanSoftball({}));
    }

    function fetchStatcrewSoftballData() {
        fetch('/get_statcrew_data/Softball')
            .then(response => response.json())
            .then(data => renderStatcrewSoftball(data || {}))
            .catch(() => renderStatcrewSoftball({}));
    }

    function fetchSoftballData() {
        fetchData('Softball');
    }

    fetchSoftballData();
    setInterval(fetchSoftballData, 1000);
    loadTrackmanSoftballConfig();
    fetchTrackmanSoftballData();
    setInterval(fetchTrackmanSoftballData, 1000);
    bindTrackmanSoftballDefaults();

    loadStatcrewConfig('Softball', 'sb');
    fetchStatcrewSoftballData();
    setInterval(fetchStatcrewSoftballData, 5000);

    document.getElementById('sb-trackman-form').addEventListener('submit', submitTrackmanSoftballConfig);
    document.getElementById('sb-statcrew-form').addEventListener('submit', function(e) {
        submitStatcrewConfig(e, 'Softball', 'sb');
    });

    document.addEventListener('dataFetched', function (event) {
        renderSoftball(event.detail || {});
    });
</script>
{% endblock %}
