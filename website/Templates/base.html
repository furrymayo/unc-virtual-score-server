<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap">
    <title>{% block title %}UDP OES Data Viewer{% endblock %}</title>

    <style>
        :root {
            --ink: #e7f0ff;
            --ink-soft: #a7bdd9;
            --navy: #0b1527;
            --navy-soft: #122742;
            --surface: #0f213d;
            --surface-soft: #142c4a;
            --carolina: #4b9cd3;
            --carolina-soft: #83c6f2;
            --accent: #f4c27a;
            --shadow: rgba(3, 8, 18, 0.55);
        }

        body {
            font-family: "Space Grotesk", system-ui, sans-serif;
            background: radial-gradient(circle at 18% 15%, rgba(75, 156, 211, 0.35) 0%, transparent 45%),
                        radial-gradient(circle at 85% 10%, rgba(131, 198, 242, 0.2) 0%, transparent 45%),
                        linear-gradient(140deg, #0b1527 0%, #0f1f36 45%, #112a46 100%);
            color: var(--ink);
            min-height: 100vh;
        }

        #navbar {
            flex-direction: column;
            background: var(--navy);
            box-shadow: 0 12px 30px var(--shadow);
        }

        .navbar-brand {
            font-weight: 700;
            letter-spacing: 0.02em;
            color: var(--ink);
        }

        .navbar-dark .navbar-nav .nav-link {
            color: var(--ink-soft);
            font-weight: 500;
        }

        .navbar-dark .navbar-nav .nav-link:hover,
        .navbar-dark .navbar-nav .nav-link:focus {
            color: var(--carolina-soft);
        }

        .config-panel {
            background: rgba(15, 33, 61, 0.9);
            border: 1px solid rgba(131, 198, 242, 0.2);
            border-radius: 12px;
            padding: 12px 16px;
            color: var(--ink);
        }

        .config-panel label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 4px;
            display: block;
            color: var(--ink-soft);
        }

        .config-panel input,
        .config-panel select {
            width: 100%;
            border-radius: 8px;
            border: 1px solid rgba(131, 198, 242, 0.25);
            background: rgba(8, 18, 34, 0.7);
            color: var(--ink);
            padding: 6px 8px;
            font-size: 0.9rem;
        }

        .config-grid {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        }

        .btn-config {
            background: var(--carolina);
            border: none;
            color: var(--navy);
            font-weight: 600;
            padding: 8px 14px;
            border-radius: 999px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn-config:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(75, 156, 211, 0.45);
        }

        .content-shell {
            padding-top: 10px;
            padding-bottom: 8px;
        }

        .scoreboard-shell {
            background: linear-gradient(140deg, rgba(15, 33, 61, 0.96), rgba(20, 44, 74, 0.95));
            border-radius: 24px;
            border: 1px solid rgba(131, 198, 242, 0.18);
            padding: 16px 20px;
            box-shadow: 0 20px 50px var(--shadow);
            backdrop-filter: blur(6px);
            position: relative;
            overflow: hidden;
            font-size: 1rem;
            transform: none;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 140px);
        }

        .scoreboard-shell::before {
            display: none;
        }

        .scoreboard-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: clamp(8px, 1vh, 16px);
        }

        .scoreboard-title {
            font-size: clamp(1.4rem, 1.8vw, 2.2rem);
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .scoreboard-subtitle {
            font-size: clamp(0.8rem, 0.9vw, 1.1rem);
            color: var(--ink-soft);
            letter-spacing: 0.06em;
            text-transform: uppercase;
        }

        .meta-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .meta-chip {
            background: var(--navy-soft);
            color: var(--ink);
            border-radius: 999px;
            padding: 4px 12px;
            font-size: clamp(0.7rem, 0.8vw, 1rem);
            letter-spacing: 0.12em;
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: 1px solid rgba(131, 198, 242, 0.18);
        }

        .meta-chip span {
            font-weight: 600;
            font-family: "JetBrains Mono", monospace;
            letter-spacing: 0.02em;
            text-transform: none;
        }

        .score-grid {
            display: grid;
            grid-template-columns: 1fr minmax(140px, 220px) 1fr;
            gap: clamp(8px, 1vw, 16px);
            align-items: stretch;
            margin-bottom: clamp(8px, 1vh, 16px);
            flex: 1;
            min-height: 0;
        }

        .team-card {
            background: linear-gradient(135deg, rgba(18, 39, 66, 0.95), rgba(20, 52, 82, 0.9));
            border-radius: 18px;
            padding: clamp(10px, 1.2vh, 20px);
            border: 1px solid rgba(131, 198, 242, 0.14);
            box-shadow: 0 10px 24px rgba(4, 12, 24, 0.3);
        }

        .team-label {
            font-size: clamp(1.1rem, 1.3vw, 1.6rem);
            text-transform: uppercase;
            letter-spacing: 0.22em;
            color: var(--ink-soft);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .team-label.is-home,
        .team-label.is-visitor {
            justify-content: center;
            font-size: clamp(1.1rem, 1.3vw, 1.6rem);
            font-weight: 700;
        }

        .team-label.is-home {
            color: var(--carolina-soft);
        }

        .team-label.is-visitor {
            color: #ffffff;
        }

        .team-score {
            font-size: clamp(3rem, 4.5vw, 5.5rem);
            font-weight: 700;
            font-family: "JetBrains Mono", monospace;
            letter-spacing: 0.02em;
            text-align: center;
            color: var(--carolina-soft);
        }

        .team-meta {
            margin-top: 12px;
            display: grid;
            gap: 6px;
        }

        .stat-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-line span {
            font-size: clamp(0.9rem, 1vw, 1.3rem);
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--ink-soft);
        }

        .stat-line strong {
            font-size: clamp(1.1rem, 1.3vw, 1.6rem);
            font-weight: 600;
            font-family: "JetBrains Mono", monospace;
        }

        .possession-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(231, 240, 255, 0.2);
        }

        .possession-dot.is-active {
            background: var(--carolina);
            box-shadow: 0 0 0 4px rgba(75, 156, 211, 0.25);
        }

        .center-card {
            background: var(--navy);
            color: var(--ink);
            border-radius: 18px;
            padding: clamp(10px, 1.2vh, 20px);
            text-align: center;
            box-shadow: 0 16px 30px rgba(4, 10, 22, 0.45);
        }

        .center-label {
            font-size: clamp(0.8rem, 0.9vw, 1.1rem);
            text-transform: uppercase;
            letter-spacing: 0.22em;
            color: rgba(231, 240, 255, 0.6);
        }

        .center-value {
            font-size: clamp(1.5rem, 2vw, 2.5rem);
            font-weight: 700;
            font-family: "JetBrains Mono", monospace;
        }

        .center-value.emphasis {
            font-size: clamp(2.8rem, 4vw, 4.5rem);
        }

        .clock-critical {
            color: #ff6b6b;
        }

        .center-divider {
            height: 1px;
            background: rgba(131, 198, 242, 0.18);
            margin: 10px 0;
        }

        .team-divider {
            height: 1px;
            background: rgba(131, 198, 242, 0.16);
            margin: 10px 0 12px;
        }

        .basketball-scoreboard .team-score {
            font-size: clamp(3.5rem, 5vw, 6rem);
            font-weight: 800;
        }

        .basketball-scoreboard .center-value.emphasis {
            font-size: clamp(3.5rem, 5vw, 5.5rem);
        }

        .basketball-scoreboard .center-value.period-small {
            font-size: clamp(1.4rem, 1.8vw, 2.2rem);
        }

        .basketball-scoreboard .center-value.shot-value {
            font-size: clamp(2.2rem, 3vw, 3.5rem);
            font-weight: 800;
        }

        /* diamond-sport uses base team-score and stat-line sizing */

        .diamond-divider {
            height: 1px;
            background: rgba(131, 198, 242, 0.16);
            margin: 10px 0 12px;
        }

        .count-row {
            display: grid;
            grid-template-columns: minmax(180px, 220px) 1fr;
            gap: 16px;
            align-items: stretch;
            margin: 18px 0 8px;
        }

        .count-row .center-card {
            padding: 14px;
        }

        @media (max-width: 768px) {
            .count-row {
                grid-template-columns: 1fr;
            }
        }

        .center-value.compact {
            font-size: clamp(1.1rem, 1.3vw, 1.6rem);
        }

        .center-label.compact {
            font-size: clamp(0.8rem, 0.9vw, 1.1rem);
            letter-spacing: 0.18em;
        }

        .count-bar {
            display: flex;
            gap: 12px;
            justify-content: center;
            align-items: center;
            margin: 18px 0 8px;
            flex-wrap: wrap;
        }

        .count-pill {
            background: rgba(11, 21, 39, 0.85);
            border: 1px solid rgba(131, 198, 242, 0.2);
            border-radius: 14px;
            padding: clamp(6px, 0.8vh, 14px) clamp(10px, 1.2vw, 20px);
            min-width: clamp(100px, 8vw, 160px);
            text-align: center;
            box-shadow: 0 10px 20px rgba(3, 9, 18, 0.35);
        }

        .count-label {
            font-size: clamp(0.85rem, 1vw, 1.2rem);
            letter-spacing: 0.22em;
            text-transform: uppercase;
            color: var(--ink-soft);
        }

        .count-value {
            font-size: clamp(2rem, 2.8vw, 3.5rem);
            font-weight: 700;
            font-family: "JetBrains Mono", monospace;
            color: var(--carolina-soft);
        }

        /* diamond-sport stat-line uses base clamp() sizing */

        .trackman-shell {
            background: rgba(11, 21, 39, 0.6);
            border: 1px solid rgba(131, 198, 242, 0.18);
            border-radius: 18px;
            padding: clamp(8px, 0.8vh, 14px);
            width: 100%;
        }

        .trackman-grid {
            display: grid;
            gap: clamp(4px, 0.5vw, 8px);
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        }

        .trackman-card {
            position: relative;
            background: rgba(18, 34, 56, 0.95);
            border: 1px solid rgba(131, 198, 242, 0.16);
            border-radius: 14px;
            padding: clamp(4px, 0.5vh, 8px) clamp(6px, 0.6vw, 10px);
            overflow: hidden;
            min-height: auto;
        }

        .trackman-card::after {
            content: "";
            position: absolute;
            right: -10px;
            top: -10px;
            width: 90px;
            height: 90px;
            background: radial-gradient(circle, rgba(131, 198, 242, 0.18), transparent 65%);
            opacity: 0.7;
        }

        .trackman-label {
            font-size: clamp(0.75rem, 0.85vw, 1rem);
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: var(--carolina-soft);
            font-weight: 700;
        }

        .trackman-value {
            font-size: clamp(1.2rem, 1.5vw, 1.8rem);
            font-weight: 700;
            font-family: "JetBrains Mono", monospace;
            margin-top: 8px;
        }

        .trackman-unit {
            font-size: clamp(0.7rem, 0.8vw, 1rem);
            color: var(--ink-soft);
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .trackman-section-label {
            font-size: clamp(0.75rem, 0.85vw, 1rem);
            letter-spacing: 0.24em;
            text-transform: uppercase;
            color: var(--ink-soft);
            margin: 2px 0 6px;
        }

        .trackman-meta {
            display: grid;
            gap: 8px;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            margin-top: 12px;
        }

        /* Dropdown indicator for collapsible panels */
        details.data-sources-panel {
            position: relative;
            z-index: 2;
        }

        details.data-sources-panel > summary .dropdown-indicator {
            display: inline-block;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 6px solid var(--carolina-soft);
            transition: transform 0.2s ease;
            margin-right: 8px;
        }

        details.data-sources-panel[open] > summary .dropdown-indicator {
            transform: rotate(180deg);
        }

        /* File browser path input group */
        .path-input-group {
            display: flex;
            gap: 6px;
        }

        .path-input-group input {
            flex: 1;
        }

        .btn-browse {
            padding: 4px 10px;
            font-size: 0.7rem;
            background: rgba(75, 156, 211, 0.25);
            border: 1px solid rgba(131, 198, 242, 0.3);
            border-radius: 6px;
            color: var(--ink);
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-browse:hover {
            background: rgba(75, 156, 211, 0.4);
        }

        /* File browser modal */
        .file-browser-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .file-browser-modal.active {
            display: flex;
        }

        .file-browser-content {
            background: var(--bg-dark);
            border: 1px solid rgba(131, 198, 242, 0.3);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .file-browser-header {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(131, 198, 242, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-browser-path-bar {
            display: flex;
            gap: 6px;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .file-browser-path {
            font-family: "JetBrains Mono", monospace;
            font-size: 0.8rem;
            color: var(--ink);
            background: rgba(8, 18, 34, 0.7);
            border: 1px solid rgba(131, 198, 242, 0.25);
            border-radius: 6px;
            padding: 4px 8px;
            flex: 1;
            min-width: 0;
        }

        .file-browser-path::placeholder {
            color: var(--ink-soft);
        }

        .file-browser-close {
            background: none;
            border: none;
            color: var(--ink);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 8px;
        }

        .file-browser-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .file-browser-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .file-browser-item:hover {
            background: rgba(75, 156, 211, 0.2);
        }

        .file-browser-item.is-dir {
            color: var(--carolina-soft);
        }

        .file-browser-item .icon {
            font-size: 1.1rem;
        }

        .trackman-config-compact {
            padding: 4px 8px;
        }

        .trackman-config-compact .config-grid {
            gap: 8px;
        }

        .trackman-config-compact label {
            font-size: 0.6rem;
        }

        .trackman-config-compact .meta-chip {
            padding: 2px 8px;
            font-size: 0.6rem;
        }

        .trackman-config-compact input,
        .trackman-config-compact select {
            padding: 3px 6px;
            font-size: 0.75rem;
        }

        .trackman-config-compact .btn-config {
            padding: 3px 8px;
            font-size: 0.7rem;
        }

        .score-trackman-layout {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: clamp(10px, 1vw, 18px);
            align-items: start;
            margin-top: clamp(8px, 1vh, 16px);
        }

        .score-trackman-layout.has-strike-zone {
            grid-template-columns: minmax(220px, 280px) minmax(0, 1fr) minmax(220px, 280px);
        }

        /* Constrained TrackMan column */
        .trackman-column {
            max-width: 280px;
            flex-shrink: 0;
        }

        .strikezone-column {
            max-width: 280px;
            width: 100%;
        }

        .trackman-column .trackman-grid {
            grid-template-columns: 1fr 1fr;
        }

        .trackman-column .trackman-card {
            padding: clamp(4px, 0.5vh, 8px) clamp(6px, 0.6vw, 10px);
            min-height: auto;
        }

        .trackman-column .trackman-value {
            font-size: clamp(1.2rem, 1.5vw, 1.8rem);
            margin-top: 4px;
        }

        /* Center stack for multiple cards */
        .center-stack {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .center-card.compact {
            padding: 6px 10px;
            min-width: 100px;
        }

        .center-card.compact .center-label {
            font-size: clamp(0.8rem, 0.9vw, 1.1rem);
        }

        .center-card.compact .center-value {
            font-size: clamp(1.5rem, 2vw, 2.5rem);
        }

        .center-card.compact .center-value.compact {
            font-size: clamp(1.1rem, 1.3vw, 1.6rem);
        }

        .trackman-zone {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
        }

        .zone-canvas {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1;
            border: 1px solid rgba(131, 198, 242, 0.35);
            border-radius: 10px;
            background: rgba(8, 18, 34, 0.6);
            overflow: hidden;
            margin: 6px auto 4px;
        }

        .zone-grid {
            position: absolute;
            width: 45%;
            height: 55%;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid rgba(131, 198, 242, 0.55);
            border-radius: 6px;
            pointer-events: none;
        }

        .zone-line {
            position: absolute;
            background: rgba(131, 198, 242, 0.22);
        }

        .zone-line.v {
            top: 0;
            bottom: 0;
            width: 1px;
        }

        .zone-line.v.v1 {
            left: 33.333%;
        }

        .zone-line.v.v2 {
            left: 66.666%;
        }

        .zone-line.h {
            left: 0;
            right: 0;
            height: 1px;
        }

        .zone-line.h.h1 {
            top: 33.333%;
        }

        .zone-line.h.h2 {
            top: 66.666%;
        }

        .zone-dot {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--carolina);
            box-shadow: 0 0 0 3px rgba(75, 156, 211, 0.25);
            transform: translate(-50%, -50%);
            left: 50%;
            top: 50%;
            pointer-events: none;
        }

        .trackman-card.trackman-zone {
            padding: 10px 12px 14px;
            min-height: 240px;
        }


        @media (max-width: 992px) {
            .score-trackman-layout {
                grid-template-columns: 1fr;
            }
        }

        .stat-grid {
            display: grid;
            gap: 12px;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        }

        .stat-card {
            background: rgba(16, 35, 60, 0.9);
            border-radius: 14px;
            padding: 12px 14px;
            border: 1px solid rgba(131, 198, 242, 0.14);
            box-shadow: 0 8px 16px rgba(3, 9, 18, 0.35);
        }

        .stat-label {
            font-size: clamp(0.85rem, 0.9vw, 1.1rem);
            letter-spacing: 0.14em;
            text-transform: uppercase;
            color: var(--ink-soft);
        }

        .stat-value {
            font-size: clamp(1.2rem, 1.5vw, 1.8rem);
            font-weight: 600;
            font-family: "JetBrains Mono", monospace;
        }

        .stat-value.compact {
            font-size: clamp(0.9rem, 1.1vw, 1.3rem);
            font-weight: 500;
            letter-spacing: 0.02em;
        }

        .team-record {
            font-size: clamp(0.75rem, 0.85vw, 1rem);
            font-weight: 400;
            color: var(--ink-soft);
            margin-left: 4px;
        }

        .badge-soft {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(75, 156, 211, 0.22);
            color: var(--ink);
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .badge-muted {
            background: rgba(231, 240, 255, 0.12);
            color: var(--ink-soft);
        }

        .section-title {
            font-size: clamp(0.85rem, 0.9vw, 1.1rem);
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: var(--ink-soft);
            margin: 18px 0 10px;
        }

        .table-card {
            background: rgba(11, 21, 39, 0.7);
            border-radius: 16px;
            padding: clamp(8px, 1vh, 16px);
            border: 1px solid rgba(131, 198, 242, 0.14);
        }

        .table-grid {
            width: 100%;
            border-collapse: collapse;
        }

        .table-grid th,
        .table-grid td {
            padding: 6px 8px;
            text-align: center;
            font-family: "JetBrains Mono", monospace;
        }

        .table-grid th {
            font-size: clamp(0.75rem, 0.9vw, 1.1rem);
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: var(--ink-soft);
        }

        .table-grid td {
            font-size: clamp(1rem, 1.2vw, 1.4rem);
            font-weight: 600;
        }

        .table-grid tbody tr {
            border-top: 1px solid rgba(131, 198, 242, 0.1);
        }

        .table-grid tbody tr:nth-child(odd) td {
            background: rgba(11, 21, 39, 0.5);
        }

        .linescore-total {
            background: rgba(75, 156, 211, 0.18);
            color: var(--ink);
            font-weight: 700;
        }

        .linescore-label {
            color: var(--carolina-soft);
            font-weight: 700;
        }

        .team-row-label {
            text-align: left;
            font-family: "Space Grotesk", sans-serif;
            font-weight: 700;
            font-size: clamp(1rem, 1.2vw, 1.4rem);
        }

        @media (max-width: 768px) {
            .score-grid {
                grid-template-columns: 1fr;
            }

            .center-card {
                order: -1;
            }
        }

        @media (max-width: 576px) {
            .scoreboard-shell {
                padding: 14px;
            }

            .meta-row {
                width: 100%;
                justify-content: flex-start;
            }

            .meta-chip {
                flex: 1 1 auto;
                justify-content: center;
            }
        }

        @keyframes rise-in {
            from {
                opacity: 0;
                transform: translateY(12px);
            }
            to {
                opacity: 1;
                transform: none;
            }
        }
    </style>
    <script>
        function fetchData(sport) {
            fetch(`/get_raw_data/${sport}`, { cache: "no-store" })
                .then(response => response.json())
                .then(data => {
                    const event = new CustomEvent('dataFetched', { detail: data });
                    document.dispatchEvent(event);
                })
                .catch(error => console.error('Error:', error));
        }

        function formatValue(value, fallback) {
            if (fallback === undefined) {
                fallback = "n/a";
            }
            if (value === undefined || value === null || value === "") {
                return fallback;
            }
            if (typeof value === "number" && Number.isNaN(value)) {
                return fallback;
            }
            return value;
        }

        function setText(id, value, fallback) {
            const el = document.getElementById(id);
            if (!el) {
                return;
            }
            el.textContent = formatValue(value, fallback);
        }

        let scoreboardSpacingRaf = null;

        function adjustScoreboardSpacing() {
            const shells = document.querySelectorAll('.scoreboard-shell');
            shells.forEach((shell) => {
                const rect = shell.getBoundingClientRect();
                const layoutHeight = shell.offsetHeight || 0;
                const delta = rect.height - layoutHeight;
                const baseGap = 16;
                const extra = Math.max(baseGap, delta + baseGap);
                shell.style.marginBottom = `${extra}px`;
            });
        }

        function scheduleScoreboardSpacing() {
            if (scoreboardSpacingRaf) {
                cancelAnimationFrame(scoreboardSpacingRaf);
            }
            scoreboardSpacingRaf = requestAnimationFrame(() => {
                adjustScoreboardSpacing();
                scoreboardSpacingRaf = null;
            });
        }

        window.addEventListener('load', () => {
            scheduleScoreboardSpacing();
            window.setTimeout(scheduleScoreboardSpacing, 700);
        });
        window.addEventListener('resize', scheduleScoreboardSpacing);
        document.addEventListener('DOMContentLoaded', scheduleScoreboardSpacing);

        function setPossession(homeId, visitorId, possession) {
            const homeDot = document.getElementById(homeId);
            const visitorDot = document.getElementById(visitorId);
            if (!homeDot || !visitorDot) {
                return;
            }
            homeDot.classList.toggle("is-active", possession === "home");
            visitorDot.classList.toggle("is-active", possession === "visitor");
        }

        function updateStrikeZone(dotId, readoutId, data, options) {
            const dot = document.getElementById(dotId);
            const readout = document.getElementById(readoutId);
            if (!dot || !readout) {
                return;
            }

            const canvas = dot.closest('.zone-canvas');
            const grid = canvas ? canvas.querySelector('.zone-grid') : null;
            if (!canvas || !grid) {
                return;
            }

            const rawX = parseFloat(data.plate_x);
            const rawY = parseFloat(data.plate_y);
            const rawZ = parseFloat(data.plate_z);
            // TrackMan: plate_x = Side (horizontal offset), plate_z = Height (vertical)
            const vertical = rawZ;

            if (!Number.isFinite(rawX) || !Number.isFinite(vertical)) {
                dot.style.display = 'none';
                readout.textContent = 'n/a';
                return;
            }

            const zone = (options && options.zone) || { minX: -0.83, maxX: 0.83, minV: 1.5, maxV: 3.3775 };
            const margin = (options && options.margin) || 1.0;
            const minX = zone.minX;
            const maxX = zone.maxX;
            const minV = zone.minV;
            const maxV = zone.maxV;

            const canvasRect = canvas.getBoundingClientRect();
            const gridRect = grid.getBoundingClientRect();
            const gridLeft = gridRect.left - canvasRect.left;
            const gridTop = gridRect.top - canvasRect.top;
            const gridWidth = gridRect.width;
            const gridHeight = gridRect.height;

            const zoneWidth = maxX - minX;
            const zoneHeight = maxV - minV;
            const xOffset = (options && options.xOffset) || 0;
            const xScale = (options && options.xScale) || 1;
            const scaleX = gridWidth / zoneWidth;
            const scaleZ = gridHeight / zoneHeight;
            const centerX = gridLeft + gridWidth / 2;
            const centerY = gridTop + gridHeight / 2;
            const zoneCenterV = (minV + maxV) / 2;

            // Negate horizontal: Side is catcher's view, we render pitcher's view
            const px = centerX - (rawX - xOffset) * scaleX * xScale;
            const pz = centerY - (vertical - zoneCenterV) * scaleZ;

            const width = canvas.clientWidth || 1;
            const height = canvas.clientHeight || 1;
            const clampedX = Math.max(0, Math.min(width, px));
            const clampedZ = Math.max(0, Math.min(height, pz));

            dot.style.display = 'block';
            dot.style.left = `${clampedX}px`;
            dot.style.top = `${clampedZ}px`;

            readout.textContent = `Side ${rawX.toFixed(2)} ft Â· Height ${vertical.toFixed(2)} ft`;
        }

        function getStatcrewTeamInfo(data) {
            const info = {
                homeName: "",
                visitorName: "",
                homeRecord: "",
                visitorRecord: "",
                venueText: "",
                weather: "",
                temp: "",
            };

            if (!data || typeof data !== "object") {
                return info;
            }

            const teams = Array.isArray(data.teams) ? data.teams : [];
            const findTeam = (tag) => teams.find(
                (team) => String(team.vh || "").toUpperCase() === tag
            ) || teams.find(
                (team) => String(team.id || "").toUpperCase() === tag
            );

            let homeTeam = findTeam("H");
            let visitorTeam = findTeam("V");

            if (!homeTeam && teams.length) {
                homeTeam = teams[0];
            }
            if (!visitorTeam && teams.length > 1) {
                visitorTeam = teams[1];
            }

            info.homeName = (homeTeam && (homeTeam.name || homeTeam.code || homeTeam.id)) || "";
            info.visitorName = (visitorTeam && (visitorTeam.name || visitorTeam.code || visitorTeam.id)) || "";
            info.homeRecord = (homeTeam && homeTeam.record) || "";
            info.visitorRecord = (visitorTeam && visitorTeam.record) || "";

            const venue = data.venue || {};
            const venueParts = [venue.stadium, venue.location].filter(Boolean);
            info.venueText = venueParts.join(" - ");
            info.weather = venue.weather || "";
            info.temp = venue.temp || "";
            return info;
        }

        // StatCrew config helpers
        function loadStatcrewConfig(sport, prefix) {
            fetch(`/statcrew_config/${sport}`)
                .then(response => response.json())
                .then(data => renderStatcrewConfig(prefix, data || {}))
                .catch(() => renderStatcrewConfig(prefix, { enabled: false }));
        }

        function submitStatcrewConfig(event, sport, prefix) {
            event.preventDefault();
            const filePath = document.getElementById(`${prefix}-statcrew-path`).value;
            const enabled = document.getElementById(`${prefix}-statcrew-enabled`).value === 'true';
            fetch(`/statcrew_config/${sport}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file_path: filePath, enabled: enabled })
            })
                .then(response => response.json())
                .then(data => renderStatcrewConfig(prefix, data || {}))
                .catch(() => renderStatcrewConfig(prefix, { enabled: false, error: 'error' }));
        }

        function renderStatcrewConfig(prefix, config) {
            const status = config.error
                ? 'error'
                : (config.enabled ? (config.running ? 'live' : 'idle') : 'disabled');
            setText(`${prefix}-sc-status`, status);
            const pathInput = document.getElementById(`${prefix}-statcrew-path`);
            const enabledSelect = document.getElementById(`${prefix}-statcrew-enabled`);
            if (pathInput) pathInput.value = config.file_path || '';
            if (enabledSelect) enabledSelect.value = config.enabled ? 'true' : 'false';
        }

        // File browser
        let fileBrowserCallback = null;
        let fileBrowserCurrentPath = '';

        function navigateToTypedPath() {
            const pathInput = document.getElementById('file-browser-path');
            if (pathInput && pathInput.value.trim()) {
                loadDirectory(pathInput.value.trim());
            }
        }

        function openFileBrowser(inputId) {
            fileBrowserCallback = inputId;
            const input = document.getElementById(inputId);
            const startPath = input && input.value ? input.value : '';
            fileBrowserCurrentPath = startPath;

            const modal = document.getElementById('file-browser-modal');
            if (modal) {
                modal.classList.add('active');
                loadDirectory(startPath || '');
            }

            const pathInput = document.getElementById('file-browser-path');
            if (pathInput) {
                pathInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        navigateToTypedPath();
                    }
                });
            }
        }

        function closeFileBrowser() {
            const modal = document.getElementById('file-browser-modal');
            if (modal) {
                modal.classList.remove('active');
            }
            fileBrowserCallback = null;
        }

        function loadDirectory(path) {
            fetch(`/browse_files?path=${encodeURIComponent(path)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Browse error:', data.error);
                    }
                    fileBrowserCurrentPath = data.current_path || path;
                    renderFileBrowser(data);
                })
                .catch(error => console.error('Browse error:', error));
        }

        function renderFileBrowser(data) {
            const pathEl = document.getElementById('file-browser-path');
            const listEl = document.getElementById('file-browser-list');

            if (pathEl) {
                pathEl.value = data.current_path || '/';
            }

            if (listEl) {
                let html = '';

                if (data.parent_path !== null && data.parent_path !== undefined) {
                    html += `<div class="file-browser-item is-dir" onclick="loadDirectory('${escapeHtml(data.parent_path)}')">
                        <span class="icon">&#x1F4C1;</span>
                        <span>..</span>
                    </div>`;
                }

                const dirs = (data.entries || []).filter(e => e.is_dir);
                const files = (data.entries || []).filter(e => !e.is_dir);

                dirs.forEach(entry => {
                    html += `<div class="file-browser-item is-dir" onclick="loadDirectory('${escapeHtml(entry.path)}')">
                        <span class="icon">&#x1F4C1;</span>
                        <span>${escapeHtml(entry.name)}</span>
                    </div>`;
                });

                files.forEach(entry => {
                    html += `<div class="file-browser-item" onclick="selectFile('${escapeHtml(entry.path)}')">
                        <span class="icon">&#x1F4C4;</span>
                        <span>${escapeHtml(entry.name)}</span>
                    </div>`;
                });

                listEl.innerHTML = html;
            }
        }

        function selectFile(path) {
            if (fileBrowserCallback) {
                const input = document.getElementById(fileBrowserCallback);
                if (input) {
                    input.value = path;
                }
            }
            closeFileBrowser();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
        }
    </script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark" id="navbar">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbar">
            <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between w-100">
                <a class="navbar-brand mb-3 mb-lg-0" href="/">Virtual Scoreboard Hub</a>
            </div>

            <div class="links">
                <div class="navbar-nav">
                    <a class="nav-item nav-link" id="Basketball" href="/Basketball">Basketball</a>
                    <a class="nav-item nav-link" id="Hockey" href="/Hockey">Hockey</a>
                    <a class="nav-item nav-link" id="Lacrosse" href="/Lacrosse">Lacrosse</a>
                    <a class="nav-item nav-link" id="Football" href="/Football">Football</a>
                    <a class="nav-item nav-link" id="Volleyball" href="/Volleyball">Volleyball</a>
                    <a class="nav-item nav-link" id="Wrestling" href="/Wrestling">Wrestling</a>
                    <a class="nav-item nav-link" id="Soccer" href="/Soccer">Soccer</a>
                    <a class="nav-item nav-link" id="Softball" href="/Softball">Softball</a>
                    <a class="nav-item nav-link" id="Baseball" href="/Baseball">Baseball</a>
                    <a class="nav-item nav-link" id="Gymnastics" href="/Gymnastics">Gymnastics</a>
                    <a class="nav-item nav-link" id="Debug" href="/Debug">DEBUG</a>
                    <!-- Add more buttons for other sports -->
                </div>
            </div>
        </div>
    </nav>
    <div class="{% block container_class %}container{% endblock %} content-shell">
        {% block content %}{% endblock %}
    </div>

    <!-- File Browser Modal -->
    <div id="file-browser-modal" class="file-browser-modal">
        <div class="file-browser-content">
            <div class="file-browser-header">
                <div class="file-browser-path-bar">
                    <input type="text" class="file-browser-path" id="file-browser-path"
                           value="/" placeholder="Type a path and press Enter..." />
                    <button class="btn-browse" onclick="navigateToTypedPath()">Go</button>
                </div>
                <button class="file-browser-close" onclick="closeFileBrowser()">&times;</button>
            </div>
            <div class="file-browser-list" id="file-browser-list"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
</body>
</html>
