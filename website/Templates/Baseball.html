{% extends "base.html" %}
{% block title %}Baseball Scoreboard{% endblock %}

{% block content %}
<section class="scoreboard-shell diamond-sport">
    <div class="scoreboard-header">
        <div>
            <div class="scoreboard-title">Baseball</div>
            <div class="scoreboard-subtitle">Live scoreboard feed</div>
        </div>
        <div class="meta-row">
            <div class="meta-chip">Pitch <span id="bs-pitch-speed">--</span></div>
        </div>
    </div>

    <details class="trackman-shell trackman-config-compact" style="margin-top: 16px;">
        <summary class="scoreboard-header" style="margin-bottom: 10px; cursor: pointer;">
            <div>
                <div class="scoreboard-subtitle">TrackMan UDP Config</div>
            </div>
            <div class="meta-row">
                <div class="meta-chip">Status <span id="bs-tm-status">n/a</span></div>
                <div class="meta-chip">Port <span id="bs-tm-port">n/a</span></div>
                <div class="meta-chip">Feed <span id="bs-tm-feed">n/a</span></div>
            </div>
        </summary>
        <form id="bs-trackman-form" class="config-grid">
            <div>
                <label for="bs-trackman-port">UDP Port</label>
                <input id="bs-trackman-port" type="number" min="1" max="65535" placeholder="20998" />
            </div>
            <div>
                <label for="bs-trackman-feed-type">Feed Type</label>
                <select id="bs-trackman-feed-type">
                    <option value="broadcast">Broadcast (Pitch + Hit, UDP 20998)</option>
                    <option value="scoreboard">Scoreboard (Pitch OR Hit, UDP 20999)</option>
                </select>
            </div>
            <div>
                <label for="bs-trackman-enabled">Enabled</label>
                <select id="bs-trackman-enabled">
                    <option value="true">Enabled</option>
                    <option value="false">Disabled</option>
                </select>
            </div>
            <div class="d-flex align-items-end">
                <button type="submit" class="btn-config w-100">Save TrackMan</button>
            </div>
        </form>
    </details>

    <div class="score-trackman-layout">
        <div>
            <div class="section-title">TrackMan Dashboard</div>
            <div class="trackman-shell">
                <div class="trackman-section-label">Pitching</div>
                <div class="trackman-grid">
                    <div class="trackman-card">
                        <div class="trackman-label">Release Speed</div>
                        <div class="trackman-value" id="bs-tm-pitch-speed">n/a</div>
                        <div class="trackman-unit">MPH</div>
                    </div>
                    <div class="trackman-card">
                        <div class="trackman-label">Spin Rate</div>
                        <div class="trackman-value" id="bs-tm-spin-rate">n/a</div>
                        <div class="trackman-unit">RPM</div>
                    </div>
                    <div class="trackman-card trackman-zone" style="grid-column: span 2;">
                        <div class="trackman-label">Strike Zone</div>
                        <div class="zone-canvas">
                            <div class="zone-grid">
                                <div class="zone-line v v1"></div>
                                <div class="zone-line v v2"></div>
                                <div class="zone-line h h1"></div>
                                <div class="zone-line h h2"></div>
                            </div>
                            <div class="zone-dot" id="bs-zone-dot"></div>
                        </div>
                        <div class="trackman-unit" id="bs-zone-readout">n/a</div>
                    </div>
                </div>
                <div class="trackman-section-label" style="margin-top: 8px;">Batting</div>
                <div class="trackman-grid">
                    <div class="trackman-card">
                        <div class="trackman-label">Exit Angle</div>
                        <div class="trackman-value" id="bs-tm-launch-angle">n/a</div>
                        <div class="trackman-unit">Degrees</div>
                    </div>
                    <div class="trackman-card">
                        <div class="trackman-label">Distance</div>
                        <div class="trackman-value" id="bs-tm-distance">n/a</div>
                        <div class="trackman-unit">Feet</div>
                    </div>
                    <div class="trackman-card">
                        <div class="trackman-label">Exit Speed</div>
                        <div class="trackman-value" id="bs-tm-exit-velocity">n/a</div>
                        <div class="trackman-unit">MPH</div>
                    </div>
                </div>
            </div>
        </div>
        <div>
            <div class="count-bar">
                <div class="count-pill">
                    <div class="count-label">Balls</div>
                    <div class="count-value" id="bs-balls">--</div>
                </div>
                <div class="count-pill">
                    <div class="count-label">Strikes</div>
                    <div class="count-value" id="bs-strikes">--</div>
                </div>
                <div class="count-pill">
                    <div class="count-label">Outs</div>
                    <div class="count-value" id="bs-outs">--</div>
                </div>
            </div>

            <div class="score-grid">
                <div class="team-card">
                    <div class="team-label">Away</div>
                    <div class="team-score" id="bs-away-runs">--</div>
                    <div class="diamond-divider"></div>
                    <div class="team-meta">
                        <div class="stat-line"><span>Hits</span><strong id="bs-away-hits">--</strong></div>
                        <div class="diamond-divider"></div>
                        <div class="stat-line"><span>Errors</span><strong id="bs-away-errors">--</strong></div>
                    </div>
                </div>
                <div class="center-card">
                    <div class="center-label">Inning</div>
                    <div class="center-value" id="bs-half-inning">n/a</div>
                    <div class="center-label compact" style="margin-top: 10px;">Batter</div>
                    <div class="center-value compact" id="bs-batter">--</div>
                </div>
                <div class="team-card">
                    <div class="team-label">Home</div>
                    <div class="team-score" id="bs-home-runs">--</div>
                    <div class="diamond-divider"></div>
                    <div class="team-meta">
                        <div class="stat-line"><span>Hits</span><strong id="bs-home-hits">--</strong></div>
                        <div class="diamond-divider"></div>
                        <div class="stat-line"><span>Errors</span><strong id="bs-home-errors">--</strong></div>
                    </div>
                </div>
            </div>

            <div class="section-title">Innings</div>
            <div class="table-card">
                <div id="bs-linescore-table"></div>
            </div>
        </div>
    </div>

    <div class="trackman-meta">
        <div class="stat-card">
            <div class="stat-label">Track ID</div>
            <div class="stat-value" id="bs-tm-track-id">n/a</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Timestamp</div>
            <div class="stat-value" id="bs-tm-time">n/a</div>
        </div>
    </div>
</section>

<script>
    function renderBaseball(data) {
        setText('bs-balls', data.balls);
        setText('bs-strikes', data.strikes);
        setText('bs-outs', data.outs);
        setText('bs-pitch-speed', data.pitch_speed);
        setText('bs-batter', data.batter_num);
        setText('bs-away-runs', data.away_runs);
        setText('bs-away-hits', data.away_hits);
        setText('bs-away-errors', data.away_errors);
        setText('bs-home-runs', data.home_runs);
        setText('bs-home-hits', data.home_hits);
        setText('bs-home-errors', data.home_errors);

        const awayInnings = Array.isArray(data.away_innings) ? data.away_innings : [];
        const homeInnings = Array.isArray(data.home_innings) ? data.home_innings : [];
        renderLinescoreBaseball(awayInnings, homeInnings, {
            away: { runs: data.away_runs, hits: data.away_hits, errors: data.away_errors },
            home: { runs: data.home_runs, hits: data.home_hits, errors: data.home_errors }
        });

        // Inning half is computed server-side via outs-transition state machine
        setText('bs-half-inning', data.inning_display);
    }

    function renderLinescoreBaseball(awayInnings, homeInnings, totals) {
        const table = document.getElementById('bs-linescore-table');
        if (!table) {
            return;
        }

        const isFilled = (value) => value !== undefined && value !== null && String(value).trim() !== '';
        const lastFilledIndex = (arr) => {
            for (let i = arr.length - 1; i >= 0; i -= 1) {
                if (isFilled(arr[i])) {
                    return i;
                }
            }
            return -1;
        };

        const lastAway = lastFilledIndex(awayInnings);
        const lastHome = lastFilledIndex(homeInnings);
        const minInnings = 9;
        const inningCount = Math.max(minInnings, lastAway + 1, lastHome + 1, awayInnings.length, homeInnings.length);

        const renderRow = (label, innings, total) => {
            const cells = [];
            cells.push(`<td class="team-row-label">${label}</td>`);
            for (let i = 0; i < inningCount; i += 1) {
                const value = formatValue(innings[i]);
                cells.push(`<td>${value}</td>`);
            }
            cells.push(`<td class="linescore-total">${formatValue(total.runs)}</td>`);
            cells.push(`<td class="linescore-total">${formatValue(total.hits)}</td>`);
            cells.push(`<td class="linescore-total">${formatValue(total.errors)}</td>`);
            return `<tr>${cells.join('')}</tr>`;
        };

        const headers = [''].concat(
            Array.from({ length: inningCount }, (_, idx) => `${idx + 1}`),
            ['R', 'H', 'E']
        );

        const headerCells = headers.map((label, index) => {
            if (index >= headers.length - 3 && label) {
                return `<th class="linescore-label">${label}</th>`;
            }
            return `<th>${label}</th>`;
        }).join('');

        table.innerHTML = `
            <table class="table-grid">
                <thead>
                    <tr>${headerCells}</tr>
                </thead>
                <tbody>
                    ${renderRow('Away', awayInnings, totals.away)}
                    ${renderRow('Home', homeInnings, totals.home)}
                </tbody>
            </table>
        `;
    }

    function renderTrackmanBaseball(data) {
        setText('bs-tm-pitch-speed', data.pitch_speed);
        setText('bs-tm-spin-rate', data.spin_rate);
        setText('bs-tm-exit-velocity', data.hit_exit_velocity);
        setText('bs-tm-launch-angle', data.hit_launch_angle);
        setText('bs-tm-distance', data.hit_distance);
        setText('bs-tm-track-id', data.track_id);
        setText('bs-tm-time', data.time);

        updateStrikeZone('bs-zone-dot', 'bs-zone-readout', data, {
            zone: { minX: -0.83, maxX: 0.83, minV: 1.5, maxV: 3.3775 },
            margin: 1.0,
            xOffset: 1.42,
            xScale: 0.85
        });
    }

    function renderTrackmanConfigBaseball(config) {
        const status = config.error
            ? 'error'
            : (config.enabled ? (config.running ? 'live' : 'idle') : 'disabled');
        setText('bs-tm-status', status);
        setText('bs-tm-port', config.port);
        setText('bs-tm-feed', config.feed_type);
        document.getElementById('bs-trackman-port').value = config.port || '';
        document.getElementById('bs-trackman-feed-type').value = config.feed_type || 'broadcast';
        document.getElementById('bs-trackman-enabled').value = config.enabled ? 'true' : 'false';
    }

    function loadTrackmanBaseballConfig() {
        fetch('/trackman_config/Baseball')
            .then(response => response.json())
            .then(data => renderTrackmanConfigBaseball(data || {}))
            .catch(() => renderTrackmanConfigBaseball({ enabled: false }));
    }

    function bindTrackmanBaseballDefaults() {
        const portInput = document.getElementById('bs-trackman-port');
        const feedSelect = document.getElementById('bs-trackman-feed-type');
        const applyDefault = () => {
            if (!portInput.value) {
                portInput.value = feedSelect.value === 'scoreboard' ? '20999' : '20998';
            }
        };
        feedSelect.addEventListener('change', applyDefault);
        applyDefault();
    }

    function submitTrackmanBaseballConfig(event) {
        event.preventDefault();
        const port = parseInt(document.getElementById('bs-trackman-port').value, 10);
        const feedType = document.getElementById('bs-trackman-feed-type').value;
        const enabled = document.getElementById('bs-trackman-enabled').value === 'true';
        fetch('/trackman_config/Baseball', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ port: port, feed_type: feedType, enabled: enabled })
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => { throw data; });
                }
                return response.json();
            })
            .then(data => renderTrackmanConfigBaseball(data || {}))
            .catch(error => renderTrackmanConfigBaseball({ enabled: false, error: error.error || 'error' }));
    }

    function fetchTrackmanBaseballData() {
        fetch('/get_trackman_data/Baseball')
            .then(response => response.json())
            .then(data => renderTrackmanBaseball(data || {}))
            .catch(() => renderTrackmanBaseball({}));
    }

    function fetchBaseballData() {
        fetchData('Baseball');
    }

    fetchBaseballData();
    setInterval(fetchBaseballData, 1000);
    loadTrackmanBaseballConfig();
    fetchTrackmanBaseballData();
    setInterval(fetchTrackmanBaseballData, 1000);
    bindTrackmanBaseballDefaults();

    document.getElementById('bs-trackman-form').addEventListener('submit', submitTrackmanBaseballConfig);

    document.addEventListener('dataFetched', function (event) {
        renderBaseball(event.detail || {});
    });
</script>
{% endblock %}
