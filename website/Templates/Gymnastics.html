{% extends "base.html" %}
{% block title %}Gymnastics Scoreboard{% endblock %}
{% block container_class %}container-fluid{% endblock %}

{% block content %}
<section class="scoreboard-shell gym-shell">

    <!-- ROW 1: Rotation bar -->
    <div class="gym-rotation-bar">
        <span class="gym-rotation-label" id="gym-rotation-label">ROTATION --</span>
        <span class="gym-rotation-events-inline" id="gym-rotation-events-inline"></span>
        <span class="gym-rotation-clock" id="gym-rotation-clock">--</span>
    </div>

    <!-- ROW 2: Teams + Clock (JS populates) -->
    <div class="gym-main-grid" id="gym-main-grid"></div>

    <!-- ROW 3: Current event lineups (JS populates) -->
    <div class="gym-lineup-grid" id="gym-lineup-grid"></div>

    <!-- ROW 4: All-around leaders -->
    <div class="gym-aa-section" id="gym-allaround">
        <div class="gym-aa-title">ALL-AROUND LEADERS</div>
        <div class="gym-aa-grid" id="gym-leaders-aa"></div>
    </div>

</section>

<!-- Config panel (collapsed by default, not visible on broadcast) -->
<details class="trackman-shell trackman-config-compact data-sources-panel" style="margin-top: 8px; margin-bottom: 12px;">
    <summary class="scoreboard-header" style="margin-bottom: 10px; cursor: pointer;">
        <div style="display: flex; align-items: center;">
            <span class="dropdown-indicator"></span>
            <div class="scoreboard-subtitle">Additional Data Sources</div>
        </div>
        <div class="meta-row">
            <div class="meta-chip">Virtius <span id="gym-virtius-status">n/a</span></div>
            <div class="meta-chip">Updated <span id="gym-updated">--</span></div>
        </div>
    </summary>

    <p style="margin: 0 0 8px; color: var(--ink-soft); font-size: 0.8rem;">
        OES clock source is configured on the <a href="/" style="color: var(--carolina-soft);">Home page</a> under Data Sources (Sport Override: Lacrosse &gt; Gymnastics).
    </p>
    <div class="section-title" style="margin-top: 8px; margin-bottom: 8px;">Virtius Live Scoring</div>
    <form id="gym-virtius-form" class="config-grid">
        <div style="grid-column: span 2;">
            <label for="gym-virtius-url">Session URL</label>
            <input id="gym-virtius-url" type="text" placeholder="https://virti.us/session?s=..." />
        </div>
        <div>
            <label for="gym-virtius-interval">Poll Interval (sec)</label>
            <input id="gym-virtius-interval" type="number" min="1" max="60" placeholder="2" />
        </div>
        <div>
            <label for="gym-virtius-enabled">Enabled</label>
            <select id="gym-virtius-enabled">
                <option value="true">Enabled</option>
                <option value="false">Disabled</option>
            </select>
        </div>
        <div class="d-flex align-items-end">
            <button type="submit" class="btn-config w-100">Save Virtius</button>
        </div>
    </form>
</details>

<style>
    .scoreboard-shell.gym-shell {
        padding: clamp(8px, 1vw, 14px);
        width: 100%;
        box-sizing: border-box;
        gap: clamp(6px, 0.8vh, 12px);
        height: auto;
        min-height: 0;
        overflow: visible;
    }

    /* --- Rotation bar --- */
    .gym-rotation-bar {
        display: flex;
        align-items: center;
        gap: 16px;
        background: rgba(7, 18, 38, 0.8);
        border: 1px solid rgba(131, 198, 242, 0.18);
        border-radius: 10px;
        padding: 6px 16px;
        flex-wrap: wrap;
    }

    .gym-rotation-label {
        font-size: clamp(0.9rem, 1.4vw, 2rem);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: var(--carolina-soft);
        white-space: nowrap;
    }

    .gym-rotation-events-inline {
        font-size: clamp(0.8rem, 1.2vw, 1.6rem);
        color: var(--ink-soft);
        letter-spacing: 0.08em;
        display: flex;
        gap: 18px;
        flex-wrap: wrap;
    }

    .gym-rotation-evt {
        white-space: nowrap;
        padding: 4px 14px;
        border-radius: 8px;
        font-weight: 600;
    }

    .gym-rotation-evt.gym-rotation-home {
        background: rgba(75, 156, 211, 0.18);
        border: 1px solid rgba(131, 198, 242, 0.3);
        color: var(--carolina-soft);
    }

    .gym-rotation-evt.gym-rotation-away {
        background: rgba(212, 106, 106, 0.12);
        border: 1px solid rgba(212, 106, 106, 0.3);
        color: var(--away-color, #d46a6a);
    }

    .gym-rotation-evt strong {
        color: var(--ink);
        margin-left: 4px;
    }

    .gym-rotation-clock {
        display: none;
        margin-left: auto;
        font-size: clamp(1.4rem, 2.4vw, 3.5rem);
        font-weight: 700;
        font-family: "JetBrains Mono", monospace;
        color: var(--ink);
        white-space: nowrap;
        letter-spacing: 0.04em;
    }

    /* --- Main grid: Home | Clock | Away (dual default) --- */
    .gym-main-grid {
        display: grid;
        grid-template-columns: 1fr minmax(360px, 540px) 1fr;
        gap: clamp(6px, 0.8vw, 12px);
        align-items: stretch;
    }

    .gym-team-card {
        padding: clamp(8px, 1vh, 14px);
        text-align: center;
    }

    .gym-team-card .team-label {
        justify-content: center;
    }

    .gym-team-total {
        font-size: clamp(2rem, 3.5vw, 5rem);
    }

    .gym-event-scores {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2px 10px;
        margin-top: 8px;
    }

    .gym-evt {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1px 0;
    }

    .gym-evt span {
        font-size: clamp(0.75rem, 1.1vw, 1.5rem);
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--ink-soft);
    }

    .gym-evt strong {
        font-size: clamp(0.85rem, 1.3vw, 1.8rem);
        font-weight: 600;
        font-family: "JetBrains Mono", monospace;
    }

    .gym-clock-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
    }

    .gym-clock-value {
        font-size: clamp(3rem, 5vw, 6rem);
        font-weight: 700;
        font-family: "JetBrains Mono", monospace;
        letter-spacing: 0.04em;
        line-height: 1;
    }

    .gym-clock-label {
        font-size: clamp(0.7rem, 1vw, 1.2rem);
        text-transform: uppercase;
        letter-spacing: 0.18em;
        color: var(--ink-soft);
        margin-top: 4px;
    }

    /* --- Team-specific colors (dual meet) --- */
    .gym-home .team-label {
        color: var(--carolina-soft);
    }

    .gym-home .team-score {
        color: var(--carolina-soft);
    }

    .gym-away .team-label {
        color: var(--away-color, #d46a6a);
    }

    .gym-away .team-score {
        color: var(--away-color, #d46a6a);
    }

    .gym-lineup-card.gym-home {
        border-left: 3px solid var(--carolina);
    }

    .gym-lineup-card.gym-home .gym-lineup-team {
        color: var(--carolina-soft);
    }

    .gym-lineup-card.gym-home .gym-lineup-event {
        color: var(--carolina-soft);
    }

    .gym-lineup-card.gym-away {
        border-left: 3px solid var(--away-color, #d46a6a);
    }

    .gym-lineup-card.gym-away .gym-lineup-team {
        color: var(--away-color, #d46a6a);
    }

    .gym-lineup-card.gym-away .gym-lineup-event {
        color: var(--away-color, #d46a6a);
    }

    /* --- Lineup cards --- */
    .gym-lineup-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: clamp(6px, 0.8vw, 12px);
    }

    .gym-lineup-card {
        background: rgba(7, 18, 38, 0.7);
        border: 1px solid rgba(131, 198, 242, 0.18);
        border-radius: 14px;
        padding: clamp(6px, 0.8vh, 12px) clamp(8px, 1vw, 14px);
    }

    .gym-lineup-header {
        display: flex;
        align-items: baseline;
        gap: 6px;
        margin-bottom: 4px;
    }

    .gym-lineup-team {
        font-size: clamp(1.1rem, 1.6vw, 2.2rem);
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--ink-soft);
        font-weight: 600;
    }

    .gym-lineup-dash {
        color: var(--ink-soft);
    }

    .gym-lineup-event {
        font-size: clamp(1.1rem, 1.6vw, 2.2rem);
        font-weight: 700;
        color: var(--carolina-soft);
    }

    .gym-lineup-table {
        display: grid;
        gap: 2px;
    }

    .gym-lineup-row {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 8px;
        align-items: baseline;
        padding: 1px 0;
    }

    .gym-lineup-order {
        font-size: clamp(1.3rem, 1.8vw, 2.3rem);
        color: var(--ink-soft);
        font-family: "JetBrains Mono", monospace;
        min-width: 1.5em;
        text-align: right;
    }

    .gym-lineup-name {
        font-size: clamp(1.4rem, 1.9vw, 2.5rem);
        font-weight: 600;
        line-height: 1.2;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .gym-lineup-score {
        font-family: "JetBrains Mono", monospace;
        font-size: clamp(1.4rem, 1.9vw, 2.5rem);
        color: var(--ink-soft);
        text-align: right;
    }

    .gym-lineup-row.has-score .gym-lineup-score {
        color: var(--ink);
        font-weight: 600;
    }

    .gym-lineup-placeholder .gym-lineup-name,
    .gym-lineup-placeholder .gym-lineup-score {
        color: rgba(167, 189, 217, 0.4);
    }

    /* --- All-around section --- */
    .gym-aa-section {
        background: rgba(7, 18, 38, 0.5);
        border: 1px solid rgba(131, 198, 242, 0.14);
        border-radius: 12px;
        padding: clamp(6px, 0.8vh, 10px) clamp(8px, 1vw, 14px);
    }

    .gym-aa-title {
        font-size: clamp(1rem, 1.4vw, 2rem);
        text-transform: uppercase;
        letter-spacing: 0.2em;
        color: var(--ink-soft);
        margin-bottom: 4px;
    }

    .gym-aa-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0 0;
    }

    .gym-aa-row {
        display: flex;
        gap: 12px;
        align-items: baseline;
        padding: 6px 14px 6px 14px;
        border-bottom: 1px solid rgba(131, 198, 242, 0.1);
        border-right: 2px solid rgba(131, 198, 242, 0.2);
    }

    .gym-aa-row:nth-child(3n) {
        border-right: none;
        padding-right: 0;
    }

    .gym-aa-row:nth-child(3n+1) {
        padding-left: 0;
    }

    .gym-aa-name {
        font-size: clamp(1.6rem, 2.1vw, 2.6rem);
        font-weight: 600;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        line-height: 1.2;
    }

    .gym-aa-sep {
        flex: 1;
        border-bottom: 1px dotted rgba(131, 198, 242, 0.2);
        min-width: 10px;
        margin-bottom: 0.25em;
    }

    .gym-aa-score {
        font-family: "JetBrains Mono", monospace;
        font-size: clamp(1.6rem, 2.1vw, 2.6rem);
        font-weight: 600;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .gym-aa-score-home {
        color: var(--carolina-soft);
    }

    .gym-aa-score-away {
        color: var(--away-color, #d46a6a);
    }

    .gym-aa-placeholder .gym-aa-name,
    .gym-aa-placeholder .gym-aa-score {
        color: rgba(167, 189, 217, 0.35);
        font-weight: 500;
    }

    .gym-aa-placeholder .gym-aa-sep {
        border-bottom-color: rgba(131, 198, 242, 0.06);
    }

    .gym-aa-placeholder {
        border-bottom-color: rgba(131, 198, 242, 0.05);
        border-right-color: rgba(131, 198, 242, 0.08);
    }

    /* --- Multi-team grid overrides --- */
    .gym-main-grid.gym-grid-3 {
        grid-template-columns: repeat(3, 1fr);
    }

    .gym-main-grid.gym-grid-4 {
        grid-template-columns: repeat(4, 1fr);
    }

    .gym-lineup-grid.gym-lineup-3 {
        grid-template-columns: repeat(3, 1fr);
    }

    .gym-lineup-grid.gym-lineup-4 {
        grid-template-columns: repeat(4, 1fr);
    }

    .gym-grid-4 .gym-event-scores {
        grid-template-columns: 1fr;
    }

    .gym-grid-4 .gym-team-total {
        font-size: clamp(1.8rem, 3vw, 4rem);
    }

    /* --- Responsive --- */
    @media (max-width: 1200px) {
        .gym-aa-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .gym-main-grid.gym-grid-4 {
            grid-template-columns: repeat(2, 1fr);
        }

        .gym-lineup-grid.gym-lineup-4 {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .gym-main-grid,
        .gym-main-grid.gym-grid-3,
        .gym-main-grid.gym-grid-4 {
            grid-template-columns: 1fr;
        }

        .gym-lineup-grid,
        .gym-lineup-grid.gym-lineup-3,
        .gym-lineup-grid.gym-lineup-4 {
            grid-template-columns: 1fr;
        }

        .gym-aa-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    const GYM_EVENT_KEYS = ['VAULT', 'BARS', 'BEAM', 'FLOOR'];
    const GYM_LINEUP_SLOTS = 6;
    const GYM_AA_LIMIT = 6;
    const GYM_EVENT_LABELS = {
        VAULT: 'Vault',
        BARS: 'Bars',
        BEAM: 'Beam',
        FLOOR: 'Floor',
        ALL_AROUND: 'All-Around'
    };

    /* --- Module-level state --- */
    var lastTeamCount = 0;
    var teamColorMap = {};
    var multiTeamCards = [];
    var multiLineupCards = [];
    var multiLineupLists = [];

    /* --- Utility --- */
    function formatGymEventLabel(code) {
        return GYM_EVENT_LABELS[code] || code || '--';
    }

    function formatUpdatedTime(timestamp) {
        if (!timestamp) return '--';
        const date = new Date(timestamp * 1000);
        if (Number.isNaN(date.getTime())) return '--';
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function getTeamColor(team) {
        if (team.home) return 'var(--carolina-soft)';
        var key = team.tricode || team.name || 'Team';
        return teamColorMap[key] || '#d46a6a';
    }

    function sortTeamsByPlace(teams) {
        return teams.slice().sort(function(a, b) {
            return (a.place || 999) - (b.place || 999);
        });
    }

    /* --- Dual-meet DOM builders --- */
    function buildDualMainGrid() {
        var grid = document.getElementById('gym-main-grid');
        if (!grid) return;
        grid.textContent = '';
        grid.className = 'gym-main-grid';

        // Home card
        var homeCard = document.createElement('div');
        homeCard.className = 'team-card gym-team-card gym-home';

        var homeLabel = document.createElement('div');
        homeLabel.className = 'team-label';
        var homeName = document.createElement('span');
        homeName.id = 'gym-home-name';
        homeName.textContent = 'Home';
        homeLabel.appendChild(homeName);
        homeCard.appendChild(homeLabel);

        var homeScore = document.createElement('div');
        homeScore.className = 'team-score gym-team-total';
        homeScore.id = 'gym-home-score';
        homeScore.textContent = '--';
        homeCard.appendChild(homeScore);

        var homeEvts = document.createElement('div');
        homeEvts.className = 'gym-event-scores';
        ['vault', 'bars', 'beam', 'floor'].forEach(function(evt) {
            var evtDiv = document.createElement('div');
            evtDiv.className = 'gym-evt';
            var span = document.createElement('span');
            span.textContent = evt.charAt(0).toUpperCase() + evt.slice(1);
            var strong = document.createElement('strong');
            strong.id = 'gym-home-' + evt;
            strong.textContent = '--';
            evtDiv.appendChild(span);
            evtDiv.appendChild(strong);
            homeEvts.appendChild(evtDiv);
        });
        homeCard.appendChild(homeEvts);
        grid.appendChild(homeCard);

        // Clock card
        var clockCard = document.createElement('div');
        clockCard.className = 'center-card gym-clock-card';
        var clockVal = document.createElement('div');
        clockVal.className = 'gym-clock-value';
        clockVal.id = 'gym-center-clock';
        clockVal.textContent = '--';
        var clockLabel = document.createElement('div');
        clockLabel.className = 'gym-clock-label';
        clockLabel.textContent = 'CLOCK';
        clockCard.appendChild(clockVal);
        clockCard.appendChild(clockLabel);
        grid.appendChild(clockCard);

        // Away card
        var awayCard = document.createElement('div');
        awayCard.className = 'team-card gym-team-card gym-away';

        var awayLabel = document.createElement('div');
        awayLabel.className = 'team-label';
        var awayName = document.createElement('span');
        awayName.id = 'gym-away-name';
        awayName.textContent = 'Away';
        awayLabel.appendChild(awayName);
        awayCard.appendChild(awayLabel);

        var awayScore = document.createElement('div');
        awayScore.className = 'team-score gym-team-total';
        awayScore.id = 'gym-away-score';
        awayScore.textContent = '--';
        awayCard.appendChild(awayScore);

        var awayEvts = document.createElement('div');
        awayEvts.className = 'gym-event-scores';
        ['vault', 'bars', 'beam', 'floor'].forEach(function(evt) {
            var evtDiv = document.createElement('div');
            evtDiv.className = 'gym-evt';
            var span = document.createElement('span');
            span.textContent = evt.charAt(0).toUpperCase() + evt.slice(1);
            var strong = document.createElement('strong');
            strong.id = 'gym-away-' + evt;
            strong.textContent = '--';
            evtDiv.appendChild(span);
            evtDiv.appendChild(strong);
            awayEvts.appendChild(evtDiv);
        });
        awayCard.appendChild(awayEvts);
        grid.appendChild(awayCard);
    }

    function buildDualLineupGrid() {
        var grid = document.getElementById('gym-lineup-grid');
        if (!grid) return;
        grid.textContent = '';
        grid.className = 'gym-lineup-grid';

        // Home lineup card
        var homeCard = document.createElement('div');
        homeCard.className = 'gym-lineup-card gym-home';

        var homeHeader = document.createElement('div');
        homeHeader.className = 'gym-lineup-header';
        var homeTeam = document.createElement('span');
        homeTeam.className = 'gym-lineup-team';
        homeTeam.id = 'gym-home-lineup-team';
        homeTeam.textContent = 'Home';
        var homeDash = document.createElement('span');
        homeDash.className = 'gym-lineup-dash';
        homeDash.textContent = '\u2014';
        var homeEvt = document.createElement('span');
        homeEvt.className = 'gym-lineup-event';
        homeEvt.id = 'gym-home-lineup-event';
        homeEvt.textContent = '--';
        homeHeader.appendChild(homeTeam);
        homeHeader.appendChild(homeDash);
        homeHeader.appendChild(homeEvt);
        homeCard.appendChild(homeHeader);

        var homeList = document.createElement('div');
        homeList.className = 'gym-lineup-table';
        homeList.id = 'gym-home-lineup-list';
        homeCard.appendChild(homeList);
        grid.appendChild(homeCard);

        // Away lineup card
        var awayCard = document.createElement('div');
        awayCard.className = 'gym-lineup-card gym-away';

        var awayHeader = document.createElement('div');
        awayHeader.className = 'gym-lineup-header';
        var awayTeam = document.createElement('span');
        awayTeam.className = 'gym-lineup-team';
        awayTeam.id = 'gym-away-lineup-team';
        awayTeam.textContent = 'Away';
        var awayDash = document.createElement('span');
        awayDash.className = 'gym-lineup-dash';
        awayDash.textContent = '\u2014';
        var awayEvt = document.createElement('span');
        awayEvt.className = 'gym-lineup-event';
        awayEvt.id = 'gym-away-lineup-event';
        awayEvt.textContent = '--';
        awayHeader.appendChild(awayTeam);
        awayHeader.appendChild(awayDash);
        awayHeader.appendChild(awayEvt);
        awayCard.appendChild(awayHeader);

        var awayList = document.createElement('div');
        awayList.className = 'gym-lineup-table';
        awayList.id = 'gym-away-lineup-list';
        awayCard.appendChild(awayList);
        grid.appendChild(awayCard);
    }

    /* --- Multi-team DOM builders --- */
    function buildMultiMainGrid(count) {
        var grid = document.getElementById('gym-main-grid');
        if (!grid) return;
        grid.textContent = '';
        grid.className = 'gym-main-grid gym-grid-' + count;

        multiTeamCards = [];
        for (var i = 0; i < count; i++) {
            var card = document.createElement('div');
            card.className = 'team-card gym-team-card';

            var label = document.createElement('div');
            label.className = 'team-label';
            var nameSpan = document.createElement('span');
            nameSpan.className = 'gym-team-name';
            nameSpan.textContent = 'Team';
            label.appendChild(nameSpan);
            card.appendChild(label);

            var scoreDiv = document.createElement('div');
            scoreDiv.className = 'team-score gym-team-total';
            scoreDiv.textContent = '--';
            card.appendChild(scoreDiv);

            var evtGrid = document.createElement('div');
            evtGrid.className = 'gym-event-scores';
            GYM_EVENT_KEYS.forEach(function(key) {
                var evt = document.createElement('div');
                evt.className = 'gym-evt';
                var span = document.createElement('span');
                span.textContent = GYM_EVENT_LABELS[key] || key;
                var strong = document.createElement('strong');
                strong.textContent = '--';
                evt.appendChild(span);
                evt.appendChild(strong);
                evtGrid.appendChild(evt);
            });
            card.appendChild(evtGrid);

            grid.appendChild(card);
            multiTeamCards.push(card);
        }
    }

    function buildMultiLineupGrid(count) {
        var grid = document.getElementById('gym-lineup-grid');
        if (!grid) return;
        grid.textContent = '';
        grid.className = 'gym-lineup-grid gym-lineup-' + count;

        multiLineupCards = [];
        multiLineupLists = [];
        for (var i = 0; i < count; i++) {
            var card = document.createElement('div');
            card.className = 'gym-lineup-card';

            var header = document.createElement('div');
            header.className = 'gym-lineup-header';
            var teamSpan = document.createElement('span');
            teamSpan.className = 'gym-lineup-team';
            teamSpan.textContent = 'Team';
            var dash = document.createElement('span');
            dash.className = 'gym-lineup-dash';
            dash.textContent = '\u2014';
            var eventSpan = document.createElement('span');
            eventSpan.className = 'gym-lineup-event';
            eventSpan.textContent = '--';
            header.appendChild(teamSpan);
            header.appendChild(dash);
            header.appendChild(eventSpan);
            card.appendChild(header);

            var list = document.createElement('div');
            list.className = 'gym-lineup-table';
            card.appendChild(list);

            grid.appendChild(card);
            multiLineupCards.push(card);
            multiLineupLists.push(list);
        }
    }

    /* --- Rendering functions --- */
    function renderRotationBar(data, teams, isMulti) {
        var rotation = data.current_rotation;
        setText('gym-rotation-label', rotation ? 'ROTATION ' + rotation : 'ROTATION --');

        var container = document.getElementById('gym-rotation-events-inline');
        if (!container) return;
        container.textContent = '';

        var map = (data.rotation_events || {})[String(rotation || '')] || {};

        teams.forEach(function(team) {
            var key = team.tricode || team.name;
            if (!key || !map[key]) return;

            var span = document.createElement('span');
            span.className = 'gym-rotation-evt ' + (team.home ? 'gym-rotation-home' : 'gym-rotation-away');
            if (!team.home && isMulti) {
                var color = getTeamColor(team);
                span.style.color = color;
                span.style.borderColor = color;
            }
            span.textContent = (team.name || 'Team') + ' ';
            var strong = document.createElement('strong');
            strong.textContent = formatGymEventLabel(map[key]);
            span.appendChild(strong);
            container.appendChild(span);
        });

        // Show/hide rotation bar clock
        var clockEl = document.getElementById('gym-rotation-clock');
        if (clockEl) clockEl.style.display = isMulti ? '' : 'none';
    }

    function renderTeam(prefix, team) {
        setText('gym-' + prefix + '-name', team.name || (prefix === 'home' ? 'Home' : 'Away'));
        setText('gym-' + prefix + '-score', team.score || '--');

        var events = team.event_scores || {};
        setText('gym-' + prefix + '-vault', events.VAULT || '--');
        setText('gym-' + prefix + '-bars', events.BARS || '--');
        setText('gym-' + prefix + '-beam', events.BEAM || '--');
        setText('gym-' + prefix + '-floor', events.FLOOR || '--');
    }

    function updateMultiTeamCard(card, team) {
        var color = getTeamColor(team);
        var nameSpan = card.querySelector('.gym-team-name');
        var scoreDiv = card.querySelector('.gym-team-total');
        var strongs = card.querySelectorAll('.gym-evt strong');

        if (nameSpan) {
            nameSpan.textContent = team.name || 'Team';
            nameSpan.style.color = color;
        }
        if (scoreDiv) {
            scoreDiv.textContent = team.score || '--';
            scoreDiv.style.color = color;
        }

        var events = team.event_scores || {};
        GYM_EVENT_KEYS.forEach(function(key, idx) {
            if (strongs[idx]) strongs[idx].textContent = events[key] || '--';
        });
    }

    function updateMultiLineupCard(card, listEl, team) {
        var color = getTeamColor(team);
        card.style.borderLeftWidth = '3px';
        card.style.borderLeftStyle = 'solid';
        card.style.borderLeftColor = color;

        var teamSpan = card.querySelector('.gym-lineup-team');
        var eventSpan = card.querySelector('.gym-lineup-event');

        if (teamSpan) {
            teamSpan.textContent = team.name || 'Team';
            teamSpan.style.color = color;
        }
        if (eventSpan) {
            eventSpan.textContent = formatGymEventLabel(team.current_event);
            eventSpan.style.color = color;
        }

        renderLineup(listEl, team.current_lineup || []);
    }

    function renderLineup(target, lineup) {
        var container = typeof target === 'string' ? document.getElementById(target) : target;
        if (!container) return;
        container.textContent = '';

        var items = Array.isArray(lineup) ? lineup.slice(0, GYM_LINEUP_SLOTS) : [];

        items.forEach(function(gymnast, index) {
            var row = document.createElement('div');
            var hasScore = gymnast.score && gymnast.score !== '' && gymnast.score !== '0.000';
            row.className = 'gym-lineup-row' + (hasScore ? ' has-score' : '');

            var order = document.createElement('span');
            order.className = 'gym-lineup-order';
            order.textContent = (index + 1) + '.';

            var name = document.createElement('span');
            name.className = 'gym-lineup-name';
            name.textContent = gymnast.name || 'Gymnast';

            var score = document.createElement('span');
            score.className = 'gym-lineup-score';
            score.textContent = gymnast.score || '0.000';

            row.appendChild(order);
            row.appendChild(name);
            row.appendChild(score);
            container.appendChild(row);
        });

        for (var i = items.length; i < GYM_LINEUP_SLOTS; i++) {
            var row = document.createElement('div');
            row.className = 'gym-lineup-row gym-lineup-placeholder';

            var order = document.createElement('span');
            order.className = 'gym-lineup-order';
            order.textContent = (i + 1) + '.';

            var name = document.createElement('span');
            name.className = 'gym-lineup-name';
            name.textContent = '--';

            var score = document.createElement('span');
            score.className = 'gym-lineup-score';
            score.textContent = '0.000';

            row.appendChild(order);
            row.appendChild(name);
            row.appendChild(score);
            container.appendChild(row);
        }
    }

    function renderAALeaders(containerId, leaders, teams) {
        var container = document.getElementById(containerId);
        if (!container) return;
        container.textContent = '';

        var items = Array.isArray(leaders) ? leaders.slice(0, GYM_AA_LIMIT) : [];

        if (!items.length) {
            container.textContent = 'No data yet';
            container.style.color = 'var(--ink-soft)';
            container.style.fontStyle = 'italic';
            return;
        }
        container.style.color = '';
        container.style.fontStyle = '';

        var homeName = '';
        teams.forEach(function(t) { if (t.home) homeName = t.name || ''; });

        items.forEach(function(leader, index) {
            var row = document.createElement('div');
            row.className = 'gym-aa-row';

            var name = document.createElement('span');
            name.className = 'gym-aa-name';
            var teamTag = leader.team ? ' (' + leader.team + ')' : '';
            name.textContent = (index + 1) + '. ' + (leader.name || 'Gymnast') + teamTag;

            var sep = document.createElement('span');
            sep.className = 'gym-aa-sep';

            var score = document.createElement('span');
            var isHome = homeName && leader.team && leader.team === homeName;
            if (isHome) {
                score.className = 'gym-aa-score gym-aa-score-home';
            } else {
                score.className = 'gym-aa-score';
                var leaderTeam = leader.team || '';
                var matched = false;
                teams.forEach(function(t) {
                    if (!t.home && !matched && (t.name === leaderTeam || t.tricode === leaderTeam)) {
                        score.style.color = getTeamColor(t);
                        matched = true;
                    }
                });
                if (!matched) {
                    score.classList.add('gym-aa-score-away');
                }
            }
            score.textContent = leader.score || '--';

            row.appendChild(name);
            row.appendChild(sep);
            row.appendChild(score);
            container.appendChild(row);
        });

        for (var i = items.length; i < GYM_AA_LIMIT; i++) {
            var row = document.createElement('div');
            row.className = 'gym-aa-row gym-aa-placeholder';

            var name = document.createElement('span');
            name.className = 'gym-aa-name';
            name.textContent = (i + 1) + '. --';

            var sep = document.createElement('span');
            sep.className = 'gym-aa-sep';

            var score = document.createElement('span');
            score.className = 'gym-aa-score';
            score.textContent = '--';

            row.appendChild(name);
            row.appendChild(sep);
            row.appendChild(score);
            container.appendChild(row);
        }
    }

    /* --- Meet orchestrators --- */
    function renderDualMeet(data, teams, clock) {
        if (lastTeamCount !== 2) {
            buildDualMainGrid();
            buildDualLineupGrid();
            lastTeamCount = 2;
        }

        var home = teams.find(function(t) { return t.home; }) || teams[0] || {};
        var away = teams.find(function(t) { return !t.home; }) || teams[1] || {};

        setText('gym-center-clock', clock || '--');
        renderRotationBar(data, teams, false);
        renderTeam('home', home);
        renderTeam('away', away);

        setText('gym-home-lineup-team', home.name || 'Home');
        setText('gym-away-lineup-team', away.name || 'Away');
        setText('gym-home-lineup-event', formatGymEventLabel(home.current_event));
        setText('gym-away-lineup-event', formatGymEventLabel(away.current_event));

        renderLineup('gym-home-lineup-list', home.current_lineup || []);
        renderLineup('gym-away-lineup-list', away.current_lineup || []);

        var allAround = (data.leaders || {}).ALL_AROUND || [];
        renderAALeaders('gym-leaders-aa', allAround, teams);
    }

    function renderMultiMeet(data, teams, clock) {
        var count = teams.length;
        if (lastTeamCount !== count) {
            buildMultiMainGrid(count);
            buildMultiLineupGrid(count);
            lastTeamCount = count;
        }

        // Sort by place (leader on left)
        var sorted = sortTeamsByPlace(teams);

        // Update rotation bar with clock
        renderRotationBar(data, teams, true);
        var clockEl = document.getElementById('gym-rotation-clock');
        if (clockEl) clockEl.textContent = clock || '--';

        // Update team cards
        sorted.forEach(function(team, idx) {
            if (multiTeamCards[idx]) updateMultiTeamCard(multiTeamCards[idx], team);
            if (multiLineupCards[idx]) updateMultiLineupCard(multiLineupCards[idx], multiLineupLists[idx], team);
        });

        var allAround = (data.leaders || {}).ALL_AROUND || [];
        renderAALeaders('gym-leaders-aa', allAround, teams);
    }

    /* --- Top-level render --- */
    function renderVirtiusGymnastics(data, clock) {
        var teams = Array.isArray(data.teams) ? data.teams : [];

        var updated = data.updated_at || (data._meta && data._meta.fetched_at);
        setText('gym-updated', updated ? formatUpdatedTime(updated) : '--');

        if (teams.length > 2) {
            renderMultiMeet(data, teams, clock);
        } else {
            renderDualMeet(data, teams, clock);
        }
    }

    function renderGymnastics(payload) {
        var clock = payload.clock || (payload.oes && payload.oes.game_clock);

        // Store team colors for use by all rendering functions
        teamColorMap = payload.team_colors || {};

        renderVirtiusGymnastics(payload.virtius || {}, clock);

        // Apply first away team color to CSS variable (backwards compat for dual meets)
        if (payload.away_team_color && typeof applyAwayTeamColor === 'function') {
            applyAwayTeamColor(payload.away_team_color);
        }
    }

    function fetchGymnasticsData() {
        fetch('/get_gymnastics_data', { cache: 'no-store' })
            .then(function(response) { return response.json(); })
            .then(function(data) { renderGymnastics(data || {}); })
            .catch(function() { renderGymnastics({}); });
    }

    /* --- Config panel (unchanged) --- */
    function renderVirtiusConfig(config) {
        var status = config.error
            ? 'error'
            : (config.enabled ? (config.running ? 'live' : 'idle') : 'disabled');
        setText('gym-virtius-status', status);

        var urlInput = document.getElementById('gym-virtius-url');
        var intervalInput = document.getElementById('gym-virtius-interval');
        var enabledSelect = document.getElementById('gym-virtius-enabled');

        if (urlInput) urlInput.value = config.session_url || '';
        if (intervalInput) intervalInput.value = config.poll_interval || '';
        if (enabledSelect) enabledSelect.value = config.enabled ? 'true' : 'false';
    }

    function loadVirtiusConfig() {
        fetch('/virtius_config/Gymnastics')
            .then(function(response) { return response.json(); })
            .then(function(data) { renderVirtiusConfig(data || {}); })
            .catch(function() { renderVirtiusConfig({ enabled: false }); });
    }

    function submitVirtiusConfig(event) {
        event.preventDefault();
        var sessionUrl = document.getElementById('gym-virtius-url').value;
        var intervalValue = parseFloat(document.getElementById('gym-virtius-interval').value);
        var enabled = document.getElementById('gym-virtius-enabled').value === 'true';

        var payload = {
            session_url: sessionUrl,
            enabled: enabled,
        };
        if (!Number.isNaN(intervalValue)) {
            payload.poll_interval = intervalValue;
        }

        fetch('/virtius_config/Gymnastics', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(function(response) {
                if (!response.ok) return response.json().then(function(data) { throw data; });
                return response.json();
            })
            .then(function(data) { renderVirtiusConfig(data || {}); })
            .catch(function(error) { renderVirtiusConfig({ enabled: false, error: error.error || 'error' }); });
    }

    /* --- Initialize --- */
    buildDualMainGrid();
    buildDualLineupGrid();
    lastTeamCount = 2;

    fetchGymnasticsData();
    setInterval(fetchGymnasticsData, 1000);

    loadVirtiusConfig();
    document.getElementById('gym-virtius-form').addEventListener('submit', submitVirtiusConfig);
</script>
{% endblock %}
