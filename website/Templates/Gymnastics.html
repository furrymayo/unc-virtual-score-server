{% extends "base.html" %}
{% block title %}Gymnastics Scoreboard{% endblock %}
{% block container_class %}container-fluid{% endblock %}

{% block content %}
<section class="scoreboard-shell gym-shell">

    <!-- ROW 1: Rotation bar -->
    <div class="gym-rotation-bar">
        <span class="gym-rotation-label" id="gym-rotation-label">ROTATION --</span>
        <span class="gym-rotation-events-inline" id="gym-rotation-events-inline"></span>
    </div>

    <!-- ROW 2: Teams + Clock -->
    <div class="gym-main-grid">
        <!-- Home team -->
        <div class="team-card gym-team-card">
            <div class="team-label"><span id="gym-home-name">Home</span></div>
            <div class="team-score gym-team-total" id="gym-home-score">--</div>
            <div class="gym-event-scores">
                <div class="gym-evt"><span>VT</span><strong id="gym-home-vault">--</strong></div>
                <div class="gym-evt"><span>UB</span><strong id="gym-home-bars">--</strong></div>
                <div class="gym-evt"><span>BB</span><strong id="gym-home-beam">--</strong></div>
                <div class="gym-evt"><span>FX</span><strong id="gym-home-floor">--</strong></div>
            </div>
        </div>

        <!-- Center clock -->
        <div class="center-card gym-clock-card">
            <div class="gym-clock-value" id="gym-center-clock">--</div>
            <div class="gym-clock-label">CLOCK</div>
        </div>

        <!-- Away team -->
        <div class="team-card gym-team-card">
            <div class="team-label"><span id="gym-away-name">Away</span></div>
            <div class="team-score gym-team-total" id="gym-away-score">--</div>
            <div class="gym-event-scores">
                <div class="gym-evt"><span>VT</span><strong id="gym-away-vault">--</strong></div>
                <div class="gym-evt"><span>UB</span><strong id="gym-away-bars">--</strong></div>
                <div class="gym-evt"><span>BB</span><strong id="gym-away-beam">--</strong></div>
                <div class="gym-evt"><span>FX</span><strong id="gym-away-floor">--</strong></div>
            </div>
        </div>
    </div>

    <!-- ROW 3: Current event lineups -->
    <div class="gym-lineup-grid">
        <div class="gym-lineup-card">
            <div class="gym-lineup-header">
                <span class="gym-lineup-team" id="gym-home-lineup-team">Home</span>
                <span class="gym-lineup-dash">&mdash;</span>
                <span class="gym-lineup-event" id="gym-home-lineup-event">--</span>
            </div>
            <div class="gym-lineup-table" id="gym-home-lineup-list"></div>
        </div>
        <div class="gym-lineup-card">
            <div class="gym-lineup-header">
                <span class="gym-lineup-team" id="gym-away-lineup-team">Away</span>
                <span class="gym-lineup-dash">&mdash;</span>
                <span class="gym-lineup-event" id="gym-away-lineup-event">--</span>
            </div>
            <div class="gym-lineup-table" id="gym-away-lineup-list"></div>
        </div>
    </div>

    <!-- ROW 4: All-around leaders -->
    <div class="gym-aa-section" id="gym-allaround">
        <div class="gym-aa-title">ALL-AROUND LEADERS</div>
        <div class="gym-aa-grid" id="gym-leaders-aa"></div>
    </div>

</section>

<!-- Config panel (collapsed by default, not visible on broadcast) -->
<details class="trackman-shell trackman-config-compact data-sources-panel" style="margin-top: 8px; margin-bottom: 12px;">
    <summary class="scoreboard-header" style="margin-bottom: 10px; cursor: pointer;">
        <div style="display: flex; align-items: center;">
            <span class="dropdown-indicator"></span>
            <div class="scoreboard-subtitle">Additional Data Sources</div>
        </div>
        <div class="meta-row">
            <div class="meta-chip">Virtius <span id="gym-virtius-status">n/a</span></div>
            <div class="meta-chip">Updated <span id="gym-updated">--</span></div>
        </div>
    </summary>

    <p style="margin: 0 0 8px; color: var(--ink-soft); font-size: 0.8rem;">
        OES clock source is configured on the <a href="/" style="color: var(--carolina-soft);">Home page</a> under Data Sources (Sport Override: Lacrosse &gt; Gymnastics).
    </p>
    <div class="section-title" style="margin-top: 8px; margin-bottom: 8px;">Virtius Live Scoring</div>
    <form id="gym-virtius-form" class="config-grid">
        <div style="grid-column: span 2;">
            <label for="gym-virtius-url">Session URL</label>
            <input id="gym-virtius-url" type="text" placeholder="https://virti.us/session?s=..." />
        </div>
        <div>
            <label for="gym-virtius-interval">Poll Interval (sec)</label>
            <input id="gym-virtius-interval" type="number" min="1" max="60" placeholder="2" />
        </div>
        <div>
            <label for="gym-virtius-enabled">Enabled</label>
            <select id="gym-virtius-enabled">
                <option value="true">Enabled</option>
                <option value="false">Disabled</option>
            </select>
        </div>
        <div class="d-flex align-items-end">
            <button type="submit" class="btn-config w-100">Save Virtius</button>
        </div>
    </form>
</details>

<style>
    .scoreboard-shell.gym-shell {
        padding: clamp(8px, 1vw, 14px);
        width: 100%;
        box-sizing: border-box;
        gap: clamp(6px, 0.8vh, 12px);
        height: auto;
        min-height: 0;
        overflow: visible;
    }

    /* --- Rotation bar --- */
    .gym-rotation-bar {
        display: flex;
        align-items: center;
        gap: 16px;
        background: rgba(7, 18, 38, 0.8);
        border: 1px solid rgba(131, 198, 242, 0.18);
        border-radius: 10px;
        padding: 6px 16px;
        flex-wrap: wrap;
    }

    .gym-rotation-label {
        font-size: clamp(0.9rem, 1.4vw, 2rem);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: var(--carolina-soft);
        white-space: nowrap;
    }

    .gym-rotation-events-inline {
        font-size: clamp(0.8rem, 1.2vw, 1.6rem);
        color: var(--ink-soft);
        letter-spacing: 0.08em;
        display: flex;
        gap: 18px;
        flex-wrap: wrap;
    }

    .gym-rotation-evt {
        white-space: nowrap;
    }

    .gym-rotation-evt strong {
        color: var(--ink);
        margin-left: 4px;
    }

    /* --- Main grid: Home | Clock | Away --- */
    .gym-main-grid {
        display: grid;
        grid-template-columns: 1fr minmax(120px, 180px) 1fr;
        gap: clamp(6px, 0.8vw, 12px);
        align-items: stretch;
    }

    .gym-team-card {
        padding: clamp(8px, 1vh, 14px);
        text-align: center;
    }

    .gym-team-total {
        font-size: clamp(2rem, 3.5vw, 5rem);
    }

    .gym-event-scores {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2px 10px;
        margin-top: 8px;
    }

    .gym-evt {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1px 0;
    }

    .gym-evt span {
        font-size: clamp(0.75rem, 1.1vw, 1.5rem);
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--ink-soft);
    }

    .gym-evt strong {
        font-size: clamp(0.85rem, 1.3vw, 1.8rem);
        font-weight: 600;
        font-family: "JetBrains Mono", monospace;
    }

    .gym-clock-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
    }

    .gym-clock-value {
        font-size: clamp(3rem, 5vw, 6rem);
        font-weight: 700;
        font-family: "JetBrains Mono", monospace;
        letter-spacing: 0.04em;
        line-height: 1;
    }

    .gym-clock-label {
        font-size: clamp(0.7rem, 1vw, 1.2rem);
        text-transform: uppercase;
        letter-spacing: 0.18em;
        color: var(--ink-soft);
        margin-top: 4px;
    }

    /* --- Lineup cards --- */
    .gym-lineup-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: clamp(6px, 0.8vw, 12px);
    }

    .gym-lineup-card {
        background: rgba(7, 18, 38, 0.7);
        border: 1px solid rgba(131, 198, 242, 0.18);
        border-radius: 14px;
        padding: clamp(6px, 0.8vh, 12px) clamp(8px, 1vw, 14px);
    }

    .gym-lineup-header {
        display: flex;
        align-items: baseline;
        gap: 6px;
        margin-bottom: 4px;
    }

    .gym-lineup-team {
        font-size: clamp(0.8rem, 1.2vw, 1.6rem);
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--ink-soft);
        font-weight: 600;
    }

    .gym-lineup-dash {
        color: var(--ink-soft);
    }

    .gym-lineup-event {
        font-size: clamp(0.8rem, 1.2vw, 1.6rem);
        font-weight: 700;
        color: var(--carolina-soft);
    }

    .gym-lineup-table {
        display: grid;
        gap: 2px;
    }

    .gym-lineup-row {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 8px;
        align-items: baseline;
        padding: 1px 0;
    }

    .gym-lineup-order {
        font-size: clamp(0.8rem, 1.1vw, 1.4rem);
        color: var(--ink-soft);
        font-family: "JetBrains Mono", monospace;
        min-width: 1.5em;
        text-align: right;
    }

    .gym-lineup-name {
        font-size: clamp(0.85rem, 1.2vw, 1.6rem);
        font-weight: 600;
        line-height: 1.2;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .gym-lineup-name.exhibition {
        color: var(--ink-soft);
        font-weight: 500;
    }

    .gym-lineup-score {
        font-family: "JetBrains Mono", monospace;
        font-size: clamp(0.85rem, 1.2vw, 1.6rem);
        color: var(--ink-soft);
        text-align: right;
    }

    .gym-lineup-row.has-score .gym-lineup-score {
        color: var(--ink);
        font-weight: 600;
    }

    .gym-lineup-placeholder .gym-lineup-name,
    .gym-lineup-placeholder .gym-lineup-score {
        color: rgba(167, 189, 217, 0.4);
    }

    /* --- All-around section --- */
    .gym-aa-section {
        background: rgba(7, 18, 38, 0.5);
        border: 1px solid rgba(131, 198, 242, 0.14);
        border-radius: 12px;
        padding: clamp(6px, 0.8vh, 10px) clamp(8px, 1vw, 14px);
    }

    .gym-aa-title {
        font-size: clamp(0.75rem, 1.1vw, 1.5rem);
        text-transform: uppercase;
        letter-spacing: 0.2em;
        color: var(--ink-soft);
        margin-bottom: 4px;
    }

    .gym-aa-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 4px 16px;
    }

    .gym-aa-row {
        display: grid;
        grid-template-columns: 1fr auto auto;
        gap: 8px;
        align-items: baseline;
    }

    .gym-aa-name {
        font-size: clamp(0.8rem, 1.1vw, 1.4rem);
        font-weight: 600;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        line-height: 1.2;
    }

    .gym-aa-events {
        font-size: clamp(0.65rem, 0.9vw, 1.1rem);
        color: var(--ink-soft);
        font-family: "JetBrains Mono", monospace;
        white-space: nowrap;
    }

    .gym-aa-score {
        font-family: "JetBrains Mono", monospace;
        font-size: clamp(0.8rem, 1.1vw, 1.4rem);
        font-weight: 600;
        text-align: right;
    }

    .gym-aa-placeholder .gym-aa-name,
    .gym-aa-placeholder .gym-aa-score,
    .gym-aa-placeholder .gym-aa-events {
        color: rgba(167, 189, 217, 0.35);
        font-weight: 500;
    }

    /* --- Responsive --- */
    @media (max-width: 1200px) {
        .gym-aa-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .gym-main-grid {
            grid-template-columns: 1fr;
        }

        .gym-lineup-grid {
            grid-template-columns: 1fr;
        }

        .gym-aa-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    const GYM_EVENT_KEYS = ['VAULT', 'BARS', 'BEAM', 'FLOOR'];
    const GYM_LINEUP_SLOTS = 6;
    const GYM_AA_LIMIT = 6;
    const GYM_EVENT_LABELS = {
        VAULT: 'Vault',
        BARS: 'Bars',
        BEAM: 'Beam',
        FLOOR: 'Floor',
        ALL_AROUND: 'All-Around'
    };

    function formatGymEventLabel(code) {
        return GYM_EVENT_LABELS[code] || code || '--';
    }

    function formatUpdatedTime(timestamp) {
        if (!timestamp) return '--';
        const date = new Date(timestamp * 1000);
        if (Number.isNaN(date.getTime())) return '--';
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function renderRotationBar(data, home, away) {
        const rotation = data.current_rotation;
        setText('gym-rotation-label', rotation ? `ROTATION ${rotation}` : 'ROTATION --');

        const container = document.getElementById('gym-rotation-events-inline');
        if (!container) return;
        container.textContent = '';

        const map = (data.rotation_events || {})[String(rotation || '')] || {};
        const homeKey = home.tricode || home.name;
        const awayKey = away.tricode || away.name;

        const pairs = [];
        if (homeKey && map[homeKey]) pairs.push({ team: home.name || 'Home', event: formatGymEventLabel(map[homeKey]) });
        if (awayKey && map[awayKey]) pairs.push({ team: away.name || 'Away', event: formatGymEventLabel(map[awayKey]) });

        pairs.forEach(function(p) {
            const span = document.createElement('span');
            span.className = 'gym-rotation-evt';
            span.textContent = p.team + ' ';
            const strong = document.createElement('strong');
            strong.textContent = p.event;
            span.appendChild(strong);
            container.appendChild(span);
        });
    }

    function renderTeam(prefix, team) {
        setText('gym-' + prefix + '-name', team.name || (prefix === 'home' ? 'Home' : 'Away'));
        setText('gym-' + prefix + '-score', team.score || '--');

        const events = team.event_scores || {};
        setText('gym-' + prefix + '-vault', events.VAULT || '--');
        setText('gym-' + prefix + '-bars', events.BARS || '--');
        setText('gym-' + prefix + '-beam', events.BEAM || '--');
        setText('gym-' + prefix + '-floor', events.FLOOR || '--');
    }

    function renderLineup(containerId, lineup) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.textContent = '';

        var items = Array.isArray(lineup) ? lineup.slice(0, GYM_LINEUP_SLOTS) : [];

        items.forEach(function(gymnast, index) {
            var row = document.createElement('div');
            var hasScore = gymnast.score && gymnast.score !== '' && gymnast.score !== '0.000';
            row.className = 'gym-lineup-row' + (hasScore ? ' has-score' : '');

            var order = document.createElement('span');
            order.className = 'gym-lineup-order';
            order.textContent = (index + 1) + '.';

            var name = document.createElement('span');
            name.className = 'gym-lineup-name';
            if (gymnast.counting === false) name.className += ' exhibition';
            name.textContent = gymnast.name || 'Gymnast';

            var score = document.createElement('span');
            score.className = 'gym-lineup-score';
            score.textContent = gymnast.score || '0.000';

            row.appendChild(order);
            row.appendChild(name);
            row.appendChild(score);
            container.appendChild(row);
        });

        for (var i = items.length; i < GYM_LINEUP_SLOTS; i++) {
            var row = document.createElement('div');
            row.className = 'gym-lineup-row gym-lineup-placeholder';

            var order = document.createElement('span');
            order.className = 'gym-lineup-order';
            order.textContent = (i + 1) + '.';

            var name = document.createElement('span');
            name.className = 'gym-lineup-name';
            name.textContent = '--';

            var score = document.createElement('span');
            score.className = 'gym-lineup-score';
            score.textContent = '0.000';

            row.appendChild(order);
            row.appendChild(name);
            row.appendChild(score);
            container.appendChild(row);
        }
    }

    function renderAALeaders(containerId, leaders) {
        var container = document.getElementById(containerId);
        if (!container) return;
        container.textContent = '';

        var items = Array.isArray(leaders) ? leaders.slice(0, GYM_AA_LIMIT) : [];

        if (!items.length) {
            container.textContent = 'No data yet';
            container.style.color = 'var(--ink-soft)';
            container.style.fontStyle = 'italic';
            return;
        }
        container.style.color = '';
        container.style.fontStyle = '';

        items.forEach(function(leader, index) {
            var row = document.createElement('div');
            row.className = 'gym-aa-row';

            var name = document.createElement('span');
            name.className = 'gym-aa-name';
            var teamTag = leader.team ? ' (' + leader.team + ')' : '';
            name.textContent = (index + 1) + '. ' + (leader.name || 'Gymnast') + teamTag;

            var events = document.createElement('span');
            events.className = 'gym-aa-events';
            var ec = leader.events_completed;
            events.textContent = ec ? ec + '/4' : '';

            var score = document.createElement('span');
            score.className = 'gym-aa-score';
            score.textContent = leader.score || '--';

            row.appendChild(name);
            row.appendChild(events);
            row.appendChild(score);
            container.appendChild(row);
        });

        for (var i = items.length; i < GYM_AA_LIMIT; i++) {
            var row = document.createElement('div');
            row.className = 'gym-aa-row gym-aa-placeholder';

            var name = document.createElement('span');
            name.className = 'gym-aa-name';
            name.textContent = (i + 1) + '. --';

            var events = document.createElement('span');
            events.className = 'gym-aa-events';
            events.textContent = '';

            var score = document.createElement('span');
            score.className = 'gym-aa-score';
            score.textContent = '--';

            row.appendChild(name);
            row.appendChild(events);
            row.appendChild(score);
            container.appendChild(row);
        }
    }

    function renderVirtiusGymnastics(data) {
        var teams = Array.isArray(data.teams) ? data.teams : [];
        var home = teams.find(function(t) { return t.home; }) || teams[0] || {};
        var away = teams.find(function(t) { return !t.home; }) || teams[1] || {};

        renderRotationBar(data, home, away);
        renderTeam('home', home);
        renderTeam('away', away);

        var homeEvent = formatGymEventLabel(home.current_event);
        var awayEvent = formatGymEventLabel(away.current_event);
        setText('gym-home-lineup-team', home.name || 'Home');
        setText('gym-away-lineup-team', away.name || 'Away');
        setText('gym-home-lineup-event', homeEvent);
        setText('gym-away-lineup-event', awayEvent);

        renderLineup('gym-home-lineup-list', home.current_lineup || []);
        renderLineup('gym-away-lineup-list', away.current_lineup || []);

        var allAround = (data.leaders || {}).ALL_AROUND || [];
        renderAALeaders('gym-leaders-aa', allAround);

        var updated = data.updated_at || (data._meta && data._meta.fetched_at);
        setText('gym-updated', updated ? formatUpdatedTime(updated) : '--');
    }

    function renderGymnastics(payload) {
        var clock = payload.clock || (payload.oes && payload.oes.game_clock);
        setText('gym-center-clock', clock || '--');
        renderVirtiusGymnastics(payload.virtius || {});
    }

    function fetchGymnasticsData() {
        fetch('/get_gymnastics_data', { cache: 'no-store' })
            .then(function(response) { return response.json(); })
            .then(function(data) { renderGymnastics(data || {}); })
            .catch(function() { renderGymnastics({}); });
    }

    function renderVirtiusConfig(config) {
        var status = config.error
            ? 'error'
            : (config.enabled ? (config.running ? 'live' : 'idle') : 'disabled');
        setText('gym-virtius-status', status);

        var urlInput = document.getElementById('gym-virtius-url');
        var intervalInput = document.getElementById('gym-virtius-interval');
        var enabledSelect = document.getElementById('gym-virtius-enabled');

        if (urlInput) urlInput.value = config.session_url || '';
        if (intervalInput) intervalInput.value = config.poll_interval || '';
        if (enabledSelect) enabledSelect.value = config.enabled ? 'true' : 'false';
    }

    function loadVirtiusConfig() {
        fetch('/virtius_config/Gymnastics')
            .then(function(response) { return response.json(); })
            .then(function(data) { renderVirtiusConfig(data || {}); })
            .catch(function() { renderVirtiusConfig({ enabled: false }); });
    }

    function submitVirtiusConfig(event) {
        event.preventDefault();
        var sessionUrl = document.getElementById('gym-virtius-url').value;
        var intervalValue = parseFloat(document.getElementById('gym-virtius-interval').value);
        var enabled = document.getElementById('gym-virtius-enabled').value === 'true';

        var payload = {
            session_url: sessionUrl,
            enabled: enabled,
        };
        if (!Number.isNaN(intervalValue)) {
            payload.poll_interval = intervalValue;
        }

        fetch('/virtius_config/Gymnastics', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(function(response) {
                if (!response.ok) return response.json().then(function(data) { throw data; });
                return response.json();
            })
            .then(function(data) { renderVirtiusConfig(data || {}); })
            .catch(function(error) { renderVirtiusConfig({ enabled: false, error: error.error || 'error' }); });
    }

    fetchGymnasticsData();
    setInterval(fetchGymnasticsData, 1000);

    loadVirtiusConfig();
    document.getElementById('gym-virtius-form').addEventListener('submit', submitVirtiusConfig);
</script>
{% endblock %}
